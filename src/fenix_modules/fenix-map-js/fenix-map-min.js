var FM,originalFM;if(typeof exports!==undefined+""){FM=exports}else{originalL=window.FM;FM={};FM.noConflict=function(){window.FM=originalFM;return this};window.FM=FM}FM.version="0.0.1";FM.author="Simone Murzilli - simone.murzilli@gmail.com; simone.murzilli@fao.org";FM.Class=function(){};FM.Class.extend=function(props){var NewClass=function(){if(this.initialize){this.initialize.apply(this,arguments)}if(this._initHooks){this.callInitHooks()}};var F=function(){};F.prototype=this.prototype;var proto=new F;proto.constructor=NewClass;NewClass.prototype=proto;for(var i in this){if(this.hasOwnProperty(i)&&i!=="prototype"){NewClass[i]=this[i]}}if(props.statics){FM.extend(NewClass,props.statics);delete props.statics}if(props.includes){FM.Util.extend.apply(null,[proto].concat(props.includes));delete props.includes}if(props.options&&proto.options){props.options=FM.extend({},proto.options,props.options)}FM.extend(proto,props);proto._initHooks=[];var parent=this;proto.callInitHooks=function(){if(this._initHooksCalled){return}if(parent.prototype.callInitHooks){parent.prototype.callInitHooks.call(this)}this._initHooksCalled=true;for(var i=0,len=proto._initHooks.length;i<len;i++){proto._initHooks[i].call(this)}};return NewClass};FM.Class.include=function(props){FM.extend(this.prototype,props)};FM.Class.mergeOptions=function(options){FM.extend(this.prototype.options,options)};FM.Class.addInitHook=function(fn){var args=Array.prototype.slice.call(arguments,1);var init=typeof fn==="function"?fn:function(){this[fn].apply(this,args)};this.prototype._initHooks=this.prototype._initHooks||[];this.prototype._initHooks.push(init)};FM.Util={loadedModules:[],dependencies:null,initializeLangProperties:function(lang){var I18NLang="";switch(lang){case"FR":I18NLang="fr";break;case"ES":I18NLang="es";break;default:I18NLang="en";break}var path=FMCONFIG.BASEURL_LANG;$.i18n.properties({name:"I18N",path:path,mode:"both",language:I18NLang})},extend:function(dest){var sources=Array.prototype.slice.call(arguments,1),i,j,len,src;for(j=0,len=sources.length;j<len;j++){src=sources[j]||{};for(i in src){if(src.hasOwnProperty(i)){dest[i]=src[i]}}}return dest},bind:function(fn,obj){var args=arguments.length>2?Array.prototype.slice.call(arguments,2):null;return function(){return fn.apply(obj,args||arguments)}},stamp:function(){var lastId=0,key="_leaflet_id";return function(obj){obj[key]=obj[key]||++lastId;return obj[key]}}(),limitExecByInterval:function(fn,time,context){var lock,execOnUnlock;return function wrapperFn(){var args=arguments;if(lock){execOnUnlock=true;return}lock=true;setTimeout(function(){lock=false;if(execOnUnlock){wrapperFn.apply(context,args);execOnUnlock=false}},time);fn.apply(context,args)}},falseFn:function(){return false},formatNum:function(num,digits){var pow=Math.pow(10,digits||5);return Math.round(num*pow)/pow},splitWords:function(str){return str.replace(/^\s+|\s+$/g,"").split(/\s+/)},setOptions:function(obj,options){obj.options=L.extend({},obj.options,options);return obj.options},getParamString:function(obj,existingUrl){var params=[];for(var i in obj){if(obj.hasOwnProperty(i)){params.push(i+"="+obj[i])}}return(!existingUrl||existingUrl.indexOf("?")===-1?"?":"&")+params.join("&")},template:function(str,data){return str.replace(/\{ *([\w_]+) *\}/g,function(str,key){var value=data[key];if(!data.hasOwnProperty(key)){throw new Error("No value provided for variable "+str)}return value})},isArray:function(obj){return Object.prototype.toString.call(obj)==="[object Array]"},emptyImageUrl:"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="};(function(){function getPrefixed(name){var i,fn,prefixes=["webkit","moz","o","ms"];for(i=0;i<prefixes.length&&!fn;i++){fn=window[prefixes[i]+name]}return fn}var lastTime=0;function timeoutDefer(fn){var time=+new Date,timeToCall=Math.max(0,16-(time-lastTime));lastTime=time+timeToCall;return window.setTimeout(fn,timeToCall)}var requestFn=window.requestAnimationFrame||getPrefixed("RequestAnimationFrame")||timeoutDefer;var cancelFn=window.cancelAnimationFrame||getPrefixed("CancelAnimationFrame")||getPrefixed("CancelRequestAnimationFrame")||function(id){window.clearTimeout(id)};FM.Util.requestAnimFrame=function(fn,context,immediate,element){fn=L.bind(fn,context);if(immediate&&requestFn===timeoutDefer){fn()}else{return requestFn.call(window,fn,element)}};FM.Util.cancelAnimFrame=function(id){if(id){cancelFn.call(window,id)}};FM.Util.replaceAll=function(text,stringToFind,stringToReplace){return text.replace(new RegExp(stringToFind,"g"),stringToReplace)},FM.Util.parseLayerRequest=function(layer){var layerValues=eval(layer);var layerRequest="";$.each(layerValues,function(key,value){layerRequest+="&"+key+"="+value});return layerRequest},FM.Util.loadModuleLibs=function(module,callback){if(!FM.Util.isModuleLoaded(module)){if(FM.Util.dependencies==null){if(FM.DEPENDENCIES[module]){FM.Util.loadDependencies(module,callback)}else{callback()}}else{FM.Util.loadDependencies(module,callback)}}else{}},FM.Util.loadDependencies=function(module,callback){var data=FM.DEPENDENCIES[module];if(typeof data=="string")data=$.parseJSON(data);if(data){var requests=[];if(data.css!=null)for(var i=0;i<data.css.length;i++){requests.push(data.css[i])}if(data.js!=null)for(var i=0;i<data.js.length;i++){requests.push(data.js[i])}ImportDependencies.importSequentially(requests,callback)}},FM.Util.isModuleLoaded=function(module){for(var i=0;i<FM.Util.loadedModules.length;i++){if(FM.Util.loadedModules[i]==module){return true}}return false},FM.Util.randomID=function(){var randLetter=Math.random().toString(36).substring(7);return(randLetter+Date.now()).toLocaleLowerCase()},FM.Util.fire=function(item,type,data){var evt=document.createEvent("CustomEvent");evt.initCustomEvent(type,true,true,data);item.dispatchEvent(evt)};FM.Util.on=function(item,type,data,callback){item.addEventListener(type,callback,false)}})();FM.extend=FM.Util.extend;FM.bind=FM.Util.bind;FM.stamp=FM.Util.stamp;FM.setOptions=FM.Util.setOptions;FM.replaceAll=FM.Util.replaceAll;FM.loadModuleLibs=FM.Util.loadModuleLibs;FM.initializeLangProperties=FM.Util.initializeLangProperties;(function(exports){function HashMap(){this.clear()}HashMap.prototype={constructor:HashMap,get:function(key){var data=this._data[this.hash(key)];return data&&data[1]},set:function(key,value){this._data[this.hash(key)]=[key,value]},has:function(key){return this.hash(key)in this._data},remove:function(key){delete this._data[this.hash(key)]},type:function(key){var str=Object.prototype.toString.call(key);var type=str.slice(8,-1).toLowerCase();if(type==="domwindow"&&!key){return key+""}return type},count:function(){var n=0;for(var key in this._data){n++}return n},clear:function(){this._data={}},hash:function(key){switch(this.type(key)){case"undefined":case"null":case"boolean":case"number":case"regexp":return key+"";case"date":return":"+key.getTime();case"string":return'"'+key;case"array":var hashes=[];for(var i=0;i<key.length;i++)hashes[i]=this.hash(key[i]);return"["+hashes.join("|");case"object":default:if(!key._hmuid_){key._hmuid_=++HashMap.uid;hide(key,"_hmuid_")}return"{"+key._hmuid_}},forEach:function(func){for(var key in this._data){var data=this._data[key];func(data[1],data[0])}}};HashMap.uid=0;function hide(obj,prop){if(Object.defineProperty){Object.defineProperty(obj,prop,{enumerable:false})}}exports.HashMap=HashMap})(this.exports||this);var RequestHandler=function(){var result={request:null,timeout:1e4,init:function(){if(typeof XDomainRequest!="undefined"){this.request=new XDomainRequest;this.setTimeout(this.timeout)}else{this.request=new XMLHttpRequest}},open:function(type,url,test){if(!this.request)this.init();if(typeof XDomainRequest=="undefined"){if(test!=null){this.request.open(type,url,test)}else this.request.open(type,url,true)}else this.request.open(type,url)},setTimeout:function(timeout){if(!this.request)this.init();if(typeof XDomainRequest!="undefined"){this.timeout=1e4}else{}},setContentType:function(contentType){if(!this.request)this.init();try{this.request.contentType=contentType}catch(e){}if(typeof XDomainRequest!="undefined"){}else{this.request.setRequestHeader("Content-Type",contentType)}},onload:function(callback){if(!this.request)this.init();this.request.onload=callback},send:function(data){if(!this.request)this.init();this.request.send(data)}};return result};FM.UIUtils={fullscreen:function(idButton,idFullscreen){var fsElement=document.getElementById(idFullscreen);if(window.fullScreenApi.supportsFullScreen){$("#"+idButton).on("click",function(){window.fullScreenApi.requestFullScreen(fsElement)})}else{}},loadingPanel:function(id,height){var h="25px";if(height)document.getElementById(id).innerHTML="<div class='fm-loadingPanel' style='height:"+h+"'></div>";else document.getElementById(id).innerHTML="<div class='fm-loadingPanel'></div>"}};$.fn.swapWith=function(to){return this.each(function(){var copy_to=$(to).clone();var copy_from=$(this).clone();$(to).replaceWith(copy_from);$(this).replaceWith(copy_to)})};FM.WMSUtils=FM.Class.extend({_divID:"",_dropdowndID:"",_outputID:"",_fenixMap:"",_wmsServers:"",_mapID:"",_lang:"EN",WMSCapabilities:function(divID,outputID,fenixmap,wmsServers,lang){this._divID=divID;this._dropdowndID=divID+"-dropdown";this._outputID=outputID;this._fenixmap=fenixmap;this._wmsServers=wmsServers;if(lang)this._lang=lang;this._createWMSDropDown(this._wmsServers,this._divID,this._dropdowndID,this._outputID,fenixmap)},_createWMSDropDown:function(wmsServers,divID,dropdowndID,outputID,fenixmap){var html='<select id="'+dropdowndID+'" style="width:200px;" data-placeholder="'+$.i18n.prop("_selectaWMSServer")+'" class="">';html+='<option value=""></option>';for(var i=0;i<wmsServers.length;i++)html+='<option value="'+wmsServers[i].url+'">'+wmsServers[i].label+"</option>";html+="</select>";$("#"+divID).empty();$("#"+divID).append(html);try{$("#"+dropdowndID).chosen({disable_search_threshold:6,width:"100%"})}catch(e){}var _this=this;$("#"+dropdowndID).change({},function(event){_this._createWMSOutputRequest(outputID,fenixmap,$(this).val())})},_createWMSOutputRequest:function(id,fenixmap,wmsServerURL){$("#"+id).empty();FM.UIUtils.loadingPanel(id,"30px");var url=FMCONFIG.BASEURL_MAPS+FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES;url+=url.indexOf("?")>0?"&":"?";url+="SERVICE=WMS";url+="&VERSION=1.1.1";url+="&request=GetCapabilities";url+="&urlWMS="+wmsServerURL;var _this=this;var xhr=new XMLHttpRequest;xhr.open("GET",url,true);xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");xhr.onload=function(){var response=this.responseText;var xmlResponse=$.parseXML(response);_this._createWMSOutput(id,fenixmap,xmlResponse,wmsServerURL)};xhr.send()},_createWMSOutput:function(id,fenixmap,xmlResponse,wmsServerURL){$("#"+id).empty();$(xmlResponse).find("Layer").each(function(){if($(this).children("Name").text()&&$(this).children("Name").text()!=""){var rand=FM.Util.randomID();var layerPanel=FM.replaceAll(FM.guiController.wmsLoaderLayer,"REPLACE",rand);$("#"+id).append(layerPanel);$("#"+rand+"-WMSLayer-title").append($(this).children("Title").text());$("#"+rand+"-WMSLayer-title").attr("title",$(this).children("Title").text());try{$("#"+rand+"-WMSLayer-title").powerTip({placement:"n"})}catch(e){}var layer={};layer.layers=$(this).children("Name").text();layer.layername=$(this).children("Name").text();layer.layertitle=$(this).children("Title").text();layer.style=$(this).children("Style").children("Name").text();layer.urlWMS=wmsServerURL;layer.srs=fenixmap.map.options.crs.code;layer.openlegend=true;$("#"+rand+"-WMSLayer-box").click({fenixmap:fenixmap,layer:layer},function(event){event.data.layer.openlegend=false;var layer=new FM.layer(event.data.layer);event.data.fenixmap.addLayer(layer);var content="The Layer <b>"+event.data.layer.layertitle+"</b><br> has been added to the map";FMPopUp.init({parentID:event.data.fenixmap.id,content:content})});var _fenixMap=fenixmap;var _layer=$.extend(true,{},layer);var _tmpLayer=new FM.layer(_layer,_fenixMap);try{$("#"+rand+"-WMSLayer-box").hoverIntent({over:function(){_tmpLayer.addLayer()},out:function(){_tmpLayer.removeLayer()},timeout:500})}catch(e){}}})},addWMSServer:function(){},_WMSCapabilities:function(id,fenixmap,wmsServerURL){var url=FMCONFIG.BASEURL_MAPS+FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES;url+=url.indexOf("?")>0?"&":"?";url+="SERVICE=WMS";url+="&VERSION=1.1.1";url+="&request=GetCapabilities";url+="&urlWMS="+wmsServerURL;var _this=this;var xhr=new XMLHttpRequest;xhr.open("GET",url,true);xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");xhr.onload=function(){var response=this.responseText;var xmlResponse=$.parseXML(response);_this._createWMSDropwDown(id,fenixmap,xmlResponse,wmsServerURL)};xhr.send()},_createWMSDropwDown:function(id,fenixmap,xmlResponse,wmsServerURL){var rand=FM.Util.randomID();$(xmlResponse).find("Layer").each(function(){var rand=FM.Util.randomID();if($(this).children("Name").text()){$("#"+id).append("<div id='WMSLayer-"+rand+"'>"+$(this).children("Title").text()+" + "+$(this).children("Style").children("Name").text()+" <div>");var layer={};layer.layers=$(this).children("Name").text();layer.layername=$(this).children("Name").text();layer.layertitle=$(this).children("Title").text();layer.style=$(this).children("Style").children("Name").text();layer.urlWMS=wmsServerURL;layer.openlegend=true;layer.srs=fenixmap.map.options.crs.code;$("#WMSLayer-"+rand).click({fenixmap:fenixmap,layer:layer},function(event){var layer=new FM.layer(event.data.layer);event.data.fenixmap.addLayerWMS(layer)})}})},WFSCapabilities:function(id,fenixmap,wmsServerURL){var url=FMCONFIG.BASEURL_MAPS+FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES;url+=url.indexOf("?")>0?"&":"?";url+="SERVICE=WFS";url+="&VERSION=1.0.0";url+="&request=GetCapabilities";url+="&urlWMS="+wmsServerURL;var xhr=new XMLHttpRequest;xhr.open("GET",url,true);xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");xhr.onload=function(){var response=this.responseText;var xmlResponse=$.parseXML(response);FM.WMSUtils._createWMSDropwDown(id,fenixmap,xmlResponse,wmsServerURL)};xhr.send()},_createWFSDropwDown:function(id,fenixmap,xmlResponse,wmsServerURL){$(xmlResponse).find("Layer").each(function(){var rand=FM.Util.randomID();if($(this).children("Name").text()){$("#"+id).append("<div id='WMSLayer-"+rand+"'>"+$(this).children("Title").text()+" + "+$(this).children("Style").children("Name").text()+" <div>");var layer={};layer.layers=$(this).children("Name").text();layer.layername=$(this).children("Name").text();layer.layertitle=$(this).children("Title").text();layer.style=$(this).children("Style").children("Name").text();layer.urlWMS=wmsServerURL;layer.openlegend=true;layer.srs=fenixmap.map.options.crs.code;$("#WMSLayer-"+rand).click({fenixmap:fenixmap,layer:layer},function(event){var layer=new FM.layer(event.data.layer);event.data.fenixmap.addLayerWMS(layer)})}})}});(function(){var fullScreenApi={supportsFullScreen:false,isFullScreen:function(){return false},requestFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",prefix:""},browserPrefixes="webkit moz o ms khtml".split(" ");if(typeof document.exitFullscreen!="undefined"){fullScreenApi.supportsFullScreen=true}else{for(var i=0,il=browserPrefixes.length;i<il;i++){fullScreenApi.prefix=browserPrefixes[i];if(typeof document[fullScreenApi.prefix+"CancelFullScreen"]!="undefined"){fullScreenApi.supportsFullScreen=true;break}}}if(fullScreenApi.supportsFullScreen){fullScreenApi.fullScreenEventName=fullScreenApi.prefix+"fullscreenchange";fullScreenApi.isFullScreen=function(){console.log("fullScreenApi.isFullScreen");switch(this.prefix){case"":return document.fullScreen;case"webkit":return document.webkitIsFullScreen;default:return document[this.prefix+"FullScreen"]}};fullScreenApi.requestFullScreen=function(el){return this.prefix===""?el.requestFullscreen():el[this.prefix+"RequestFullScreen"]()};fullScreenApi.cancelFullScreen=function(el){return this.prefix===""?document.exitFullscreen():document[this.prefix+"CancelFullScreen"]()}}if(typeof jQuery!="undefined"){jQuery.fn.requestFullScreen=function(){return this.each(function(){var el=jQuery(this);if(fullScreenApi.supportsFullScreen){fullScreenApi.requestFullScreen(el)}})}}window.fullScreenApi=fullScreenApi})();FM.DEPENDENCIES={FENIX_REPOSITORY:"fenixapps.fao.org/repository",fenixmap:{js:["http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js","http://fenixapps.fao.org/repository/js/jquery/1.9.1/jquery.min.js","http://fenixapps.fao.org/repository/js/jquery/1.0.9/jquery.i18n.properties-min.js","http://code.jquery.com/ui/1.10.3/jquery-ui.js","http://fenixapps.fao.org/repository/js/jquery.power.tip/1.2.0/jquery.powertip.min.js","http://fenixapps.fao.org/repository/js/FENIX/utils/import-dependencies-1.0.js","http://hqlprfenixapp2.hq.un.fao.org:13000/repository/js/jquery.pageslide/2.0/jquery.pageslide.min.js","js/FENIXMap.js","js/core/Class.js","js/core/Util.js","js/core/hashmap.js","js/map/config/CONFIG.js","js/map/config/DEPENDENCIES.js","js/map/Map.js","js/map/controller/MapController.js","js/map/layer/Layer.js","js/map/layer/TileLayer.js","js/map/constants/TILELAYER.js","js/map/gui/gui-controller.js","js/map/gui/gui-map.js","js/core/fullscreen.js","js/core/UIUtils.js"],css:["http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css","http://fenixapps.fao.org/repository/js/jquery.power.tip/1.2.0/css/jquery.powertip.css","http://hqlprfenixapp2.hq.un.fao.org:13000/repository/js/jquery.pageslide/2.0/jquery.pageslide.min.css","css/fenix-map.css"]},geocoder:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.geocoder/1.0/Control.OSMGeocoder.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.geocoder/1.0/Control.OSMGeocoder.css"]},geosearch:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.geosearch/1.0/l.control.geosearch.js","http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.geosearch/1.0/l.geosearch.provider.openstreetmap.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.geosearch/1.0/l.geosearch.css"]},mouseposition:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.mouseposition/1.0/L.Control.MousePosition.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.mouseposition/1.0/L.Control.MousePosition.css"]},drawcontrol:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.draw/1.0/leaflet.draw.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.draw/1.0/leaflet.draw.css"]},exportplugin:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.export/1.0/export.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.export/1.0/export.css"]},controlloading:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.control.loading/1.0/Control.Loading.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.control.loading/1.0/Control.Loading.css"]}};FMDEFAULTLAYER={getLayer:function(layertype,isjoin,measurementunit){switch(layertype.toUpperCase()){case"GAUL0":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857_2","adm0_code","the_geom",isjoin,"faost_n",measurementunit,"GAUL");break;case"GAUL0_FAOSTAT":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857","faost_code","the_geom",isjoin,"faost_n",measurementunit,"FAOSTAT");break;case"GAUL0_ISO2":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857_2","iso2_code","the_geom",isjoin,"faost_n",measurementunit,"ISO2");break;case"GAUL0_ISO3":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857_2","iso3_code","the_geom",isjoin,"faost_n",measurementunit,"ISO3");break;case"GAUL0_BOUNDARIES":return FMDEFAULTLAYER._getWMSLayer("gaul0_line_3857");break;case"GAUL1":return FMDEFAULTLAYER._getGAUL("gaul1_3857","adm1_code","the_geom",isjoin,"adm1_name",measurementunit,null);break;case"GAUL2":return FMDEFAULTLAYER._getGAUL("gaul2_3857","adm2_code","the_geom",isjoin,"adm2_name",measurementunit,null);break}},_getGAUL:function(layername,joincolumn,geometrycolumn,isjoin,joincolumnlabel,measurementunit,joinboundary){var layer={};layer.layers=layername;layer.styles="";layer.joincolumn=joincolumn?joincolumn:null;layer.joincolumnlabel=joincolumnlabel?joincolumnlabel:null;layer.measurementunit=measurementunit?measurementunit:null;layer.srs="EPSG:3857";layer.geometrycolumn=geometrycolumn?geometrycolumn:"";if(isjoin){FMDEFAULTLAYER.joinDefaultPopUp(layer);layer.joinboundary=joinboundary}return layer},_getWMSLayer:function(layername,urlWMS,styles,srs){var layer={};layer.layers=layername;layer.styles=styles?styles:"";layer.srs=srs?srs:"EPSG:3857";layer.urlWMS=urlWMS?urlWMS:FMCONFIG.DEFAULT_WMS_SERVER;return layer},joinDefaultPopUp:function(layer){var measurementunit=layer.measurementunit?" "+layer.measurementunit+"":"";var joinlabel=layer.joincolumnlabel?"<div class='fm-popup-join-title'>{{"+layer.joincolumnlabel+"}}</div>":"";layer.customgfi={content:{en:"<div class='fm-popup'>"+joinlabel+"<div class='fm-popup-join-content'>{{{"+layer.joincolumn+"}}} <i>"+measurementunit+"</i></div></div>",fr:"<div class='fm-popup'>"+joinlabel+"{{{"+layer.joincolumn+"}}} <i>"+measurementunit+"</i></div>",es:"<div class='fm-popup'>"+joinlabel+"{{{"+layer.joincolumn+"}}} <i>"+measurementunit+"</i></div>"},showpopup:true,output:{show:true,id:"gfiid"},callback:function(response,custompopup){$("#"+custompopup.outputid).empty();$("#"+custompopup.outputid).append(response)}}}};FM.TILELAYER={OSM:{URL:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",TITLE_EN:"OSM - OpenStreetMap",TITLE_FR:"OSM - OpenStreetMap"},OSM_GRAYSCALE:{URL:"http://{s}.www.toolserver.org/tiles/bw-mapnik/{z}/{x}/{y}.png",TITLE_EN:"OSM - OpenStreetMap grayscale",TITLE_FR:"OSM - OpenStreetMap grayscale"},MAPQUEST:{URL:"http://otile1.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png",TITLE_EN:"MapQuest"},MAPQUEST_NASA_AERIAL:{URL:"http://tile21.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png",TITLE_EN:"MapQuest Aerial"},ESRI_WORLDSTREETMAP:{URL:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}.png",TITLE_EN:"ESRI - World Street Map",TITLE_FR:"ESRI - World Street Map"},ESRI_WORLDTERRAINBASE:{URL:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}",TITLE_EN:"ESRI - World Terrain Base",TITLE_FR:"ESRI - World Terrain Base"},ACETATE_LABELS:{URL:"http://a{s}.acetate.geoiq.com/tiles/acetate-labels/{z}/{x}/{y}.png",TITLE_EN:"Acetate Labels"},ACETATE_TERRAIN:{URL:"http://a{s}.acetate.geoiq.com/tiles/terrain/{z}/{x}/{y}.png",TITLE_EN:"Acetate Terrain"},STAMEN_TONER_BACKGROUND:{URL:"http://{s}.tile.stamen.com/toner-background/{z}/{x}/{y}.png",TITLE_EN:"Stamen"},ESRI_HISTORICAL_MERCATOR:{URL:"http://tiles2.arcgis.com/tiles/IEuSomXfi6iB7a25/arcgis/rest/services/World_Globe_1812/MapServer/{z}/{x}/{y}.png",TITLE_EN:"ESRI_HISTORICAL_MERCATOR"}};FM.WMSSERVERS={DEFAULT_EXTERNAL_WMS_SERVERS:[{label:"FENIX WMS Server",label_EN:"FENIX",url:"http://hqlprfenixapp2.hq.un.fao.org:12100/geoserver/wms"},{label:"DATA FAO ORG",label_EN:"DATA FAO ORG",url:"http://data.fao.org/maps/wms"},{label:"UNREDD Congo",label_EN:"UNREDD Congo",url:"http://rdc-snsf.org/diss_geoserver/gwc/service/wms"},{label:"Wales OpenData",label_EN:"Wales OpenData",url:"http://inspire.wales.gov.uk/maps/ows"},{label:"Scotland OpenData",label_EN:"Scotland OpenData",url:"http://sedsh127.sedsh.gov.uk/arcgis/services/ScotGov/StatisticalUnits/MapServer/WMSServer"},{label:"Netherlands OpenData",label_EN:"Netherlands OpenData",url:"http://geodata.nationaalgeoregister.nl/ahn2/wcs"},{label:"German OpenData",label_EN:"German OpenData",url:"http://geo.sv.rostock.de/geodienste/verwaltung/wms"},{label:"ENVIRONMENT OpenData",label_EN:"Scotland OpenData",url:"http://lasigpublic.nerc-lancaster.ac.uk/ArcGIS/services/Biodiversity/GMFarmEvaluation/MapServer/WMSServer"},{label:"OpenGeo Demo Server",label_EN:"OpenGeo Demo Server",url:"http://demo.opengeo.org/geoserver/ows"},{label:"HarvestChoice 1",label_EN:"HarvestChoice 1",url:"http://apps.harvestchoice.org/arcgis/services/MapServices/cell_values_1/MapServer/WMSServer"},{label:"HarvestChoice 2",label_EN:"HarvestChoice 2",url:"http://apps.harvestchoice.org/arcgis/services/MapServices/cell_values_2/MapServer/WMSServer"},{label:"HarvestChoice 3",label_EN:"HarvestChoice 3",url:"http://apps.harvestchoice.org/arcgis/services/MapServices/cell_values_3/MapServer/WMSServer"},{label:"HarvestChoice 4",label_EN:"HarvestChoice 4",url:"http://apps.harvestchoice.org/arcgis/services/MapServices/cell_values_4/MapServer/WMSServer"},{label:"HarvestChoice 5",label_EN:"HarvestChoice 5",url:"http://apps.harvestchoice.org/arcgis/services/MapServices/cell_values_5/MapServer/WMSServer"},{label:"HarvestChoice 6",label_EN:"HarvestChoice 6",url:"http://apps.harvestchoice.org/arcgis/services/MapServices/cell_values_6/MapServer/WMSServer"},{label:"Alberts Map Service",url:"http://maps.gov.bc.ca/arcserver/services/Province/albers_cache/MapServer/WMSServer",urlParameters:"service=WMS"},{label:"Cubert Map Service",label_EN:"Cubert",url:"http://portal.cubewerx.com/cubewerx/cubeserv/cubeserv.cgi"},{label:"GP Map Service",label_EN:"gp map service201",url:"http://geoportal.logcluster.org:8081/gp_map_service201/wms"},{label:"Vienna OpenData",label_EN:"Vienna OpenData",url:"http://data.wien.gv.at/daten/wms"}]};FM.Map=FM.Class.extend({id:"",suffix:"",mapContainerID:"",tilePaneID:"",map:"",controller:"",mapOptions:{center:[0,0],lat:0,lng:0,zoom:1},options:{guiController:{enablegfi:true},gui:{fullscreen:true,fullscreenID:""},usedefaultbaselayers:true,lang:"EN"},initialize:function(id,options,mapOptions){this.options=$.extend(true,{},this.options,options);this.mapOptions=$.extend(true,{},this.mapOptions,mapOptions);FM.initializeLangProperties(this.options.lang);var suffix=FM.Util.randomID();var mapContainerID=suffix+"-container-map";var mapID=suffix+"-map";$("#"+id).append("<div class='fm-map-box fm-box' id='"+mapContainerID+"'><div>");$("#"+mapContainerID).append("<div style='width:100%; height: 100%;' id='"+mapID+"'><div>");this.id=mapID;this.mapContainerID=mapContainerID;this.suffix=suffix;this.options.gui.fullscreenID=this.options.gui.fullscreenID!=""?this.options.gui.fullscreenID:this.mapContainerID;this.map=new L.Map(this.id,this.mapOptions);this.setTilePaneID();$("#"+mapContainerID).append("<div style='width:350px;' id='"+suffix+"-controller'><div>");this.controller=new FM.mapController(suffix,this,this.map,this.options.guiController);this.controller.initializeGUI();var _this=this;this.map._fenixMap=this;this.map.on("click",function(e){if(_this.options.guiController.enablegfi)_this.getFeatureInfo(e)});$("#"+mapContainerID).append("<div id='"+suffix+"-popup'><div>");$("#"+mapContainerID).append("<div  class='fm-swipe' id='"+suffix+"-swipe'><div style='display:none' class='fm-swipe-handle'id='"+suffix+"-handle'>&nbsp</div></div>");$("#"+mapContainerID).append(FM.replaceAll(FM.guiController.popUpJoinPoint,"REPLACE",suffix))},createMap:function(lat,lng,zoom){if(lat)this.mapOptions.lat=lat;if(lng)this.mapOptions.lon=lng;if(zoom)this.mapOptions.zoom=zoom;this.map.setView(new L.LatLng(this.mapOptions.lat,this.mapOptions.lng),this.mapOptions.zoom);L.control.scale("bottomright").addTo(this.map);this.initializePlugins();this.initializeMapGUI();if(this.options.usedefaultbaselayers)this._addDefaultBaseLayers();$("#"+this.id+" .leaflet-control-zoom-in").html("");$("#"+this.id+" .leaflet-control-zoom-out").html("")},_addDefaultBaseLayers:function(){this.addTileLayer(FM.TileLayer.createBaseLayer("OSM","EN"),true);this.addTileLayer(FM.TileLayer.createBaseLayer("OSM_GRAYSCALE","EN"),true);this.addTileLayer(FM.TileLayer.createBaseLayer("ESRI_WORLDSTREETMAP","EN"),true);this.addTileLayer(FM.TileLayer.createBaseLayer("ESRI_WORLDTERRAINBASE","EN"),true)},setTilePaneID:function(){this.tilePaneID=this.suffix+"-leaflet-tile-pane";var childNodes=document.getElementById(this.id).childNodes;var childNodes2=childNodes[1].childNodes;$(childNodes2[0]).attr("id",this.tilePaneID)},addTileLayer:function(l,isBaseLayer){if(isBaseLayer)this.controller.addBaseLayer(l);else{this.controller.layerAdded(l);this.map.addLayer(l.leafletLayer)}this.controller.setZIndex(l)},addLayer:function(l){if(l.layer.layertype){switch(l.layer.layertype){case"JOIN":if(l.layer.jointype.toLocaleUpperCase()=="SHADED")this.addShadedLayer(l);else if(l.layer.jointype.toLocaleUpperCase()=="POINT")this.addPointLayer(l);break;case"WMS":this.addLayerWMS(l);break;default:this.addLayerWMS(l);break}}else{this.addLayerWMS(l)}},removeLayer:function(l){this.controller.removeLayer(l)},addLayerWMS:function(l){this.controller.layerAdded(l);this.map.addLayer(l.createLayerWMS());this.controller.setZIndex(l);this._openlegend(l,false);this.controller.showHide(l.id,false)},addShadedLayer:function(l){if(!l.layerAdded)this.controller.layerAdded(l);this.createShadeLayerRequest(l,l.isadded)},createShadeLayerRequest:function(l,isReload){if(!isReload){$("#"+l.id+"-controller-item-getlegend").css("display","inline-block");$("#"+l.id+"-controller-item-opacity").css("display","block")}var _this=this;var url=FMCONFIG.BASEURL_MAPS+FMCONFIG.MAP_SERVICE_SHADED;var r=new RequestHandler;r.open("POST",url);r.setContentType("application/x-www-form-urlencoded");r.request.onload=function(){_this._createShadeLayer(l,this.responseText,isReload)};r.send(FM.Util.parseLayerRequest(l.layer))},_createShadeLayer:function(l,response,isReload){if(typeof response=="string")response=$.parseJSON(response);l.layer.sldurl=response.sldurl;l.layer.urlWMS=response.geoserverwms;l.layer.legendHTML=response.legendHTML;l.createLayerWMSSLD();this._loadLayer(l,isReload)},createShadedLayerRequestCached:function(l,isReload){if(l.layer.sldurl)this._loadLayer(l,isReload);else{this.createShadeLayerRequest(l,isReload)}},_loadLayer:function(l,isReload){var isReload=isReload==null||!isReload?false:true;if(!isReload){this.map.addLayer(l.leafletLayer);this.controller.setZIndex(l);l.isadded=true}else l.leafletLayer.redraw();this._openlegend(l,isReload);this.controller.showHide(l.id,isReload)},reAddLayer:function(l){this.map.addLayer(l.leafletLayer);this.controller.setZIndex(l)},_openlegend:function(l,isReload){if(l.layer.openlegend){FM.LayerLegend.getLegend(l,l.id+"-controller-item-getlegend",isReload)}},addPointLayer:function(l){this.controller.layerAdded(l);this.createPointLayerRequest(l)},createPointLayerRequest:function(l){$("#"+l.id+"-controller-item-getlegend").css("display","none");$("#"+l.id+"-controller-item-getlegend-holder").slideUp("slow");$("#"+l.id+"-controller-item-opacity").css("display","none");var _this=this;var url=FMCONFIG.BASEURL_MAPS+FMCONFIG.MAP_SERVICE_SHADED;var r=new RequestHandler;r.open("POST",url);r.setContentType("application/x-www-form-urlencoded");r.request.onload=function(){_this._createPointLayer(l,this.responseText)};r.send(FM.Util.parseLayerRequest(l.layer));r.request.onerror=function(){if(l.layer.pointsLayers){for(var i=0;i<l.layer.pointsLayers.length;i++){this.map.removeLayer(l.layer.pointsLayers[i])}}}},_createPointLayer:function(l,response){if(typeof response=="string")response=$.parseJSON(response);l.layer.sldurl=response.sldurl;l.layer.urlWMS=response.geoserverwms;l.layer.legendHTML=response.legendHTML;l.layer.pointsJSON=response.pointsJSON;this._refreshPointLayer(l)},_refreshPointLayer:function(l){if(l.layer.pointsLayers){for(var i=0;i<l.layer.pointsLayers.length;i++){this.map.removeLayer(l.layer.pointsLayers[i])}}if(typeof l.layer.pointsJSON=="string")l.layer.pointsJSON=$.parseJSON(l.layer.pointsJSON);var _this=this;l.layer.pointsLayers=[];for(var i=0;i<l.layer.pointsJSON.length;i++){var latlon=new L.LatLng(l.layer.pointsJSON[i].lat,l.layer.pointsJSON[i].lon);var properties=l.layer.pointsJSON[i].properties;l.layer.pointsJSON[i].properties.measurementunit="";if(l.layer.measurementuni!=null)l.layer.pointsJSON[i].properties.measurementunit=l.layer.measurementunit;if(l.layer.pointColor!=null)properties.color=l.layer.pointColor;
if(l.layer.pointFillColor!=null)properties.fillColor=l.layer.pointFillColor;if(l.layer.pointFillOpacity!=null)properties.fillOpacity=l.layer.pointFillOpacity;var marker=new L.CircleMarker(latlon,properties).addTo(this.map);marker.setRadius(l.layer.pointsJSON[i].radius);marker.bindPopup(properties.title+" - "+properties.value);marker.on("mouseover",function(){$("#"+_this.suffix+"-popup-join-point-holder").show();$("#"+_this.suffix+"-popup-join-point-text").empty();$("#"+_this.suffix+"-popup-join-point-value").empty();$("#"+_this.suffix+"-popup-join-point-text").append(this.options.title);$("#"+_this.suffix+"-popup-join-point-value").append(this.options.value+"  <i>"+l.layer.measurementunit+"</i>")});marker.on("mouseout",function(){$("#"+_this.suffix+"-popup-join-point-holder").hide()});l.layer.pointsLayers.push(marker)}},addGeoJSON:function(l){FMGeoJSON.createGeoJSONLayer(l)},syncOnMove:function(mapToSync){FM.MapUtils.syncMapsOnMove(this.map,mapToSync)},getFeatureInfo:function(e,l){var fenixMap=e.target._fenixMap;var l=l?l:fenixMap.controller.selectedLayer;if(l){if(l.layer.layertype!=null&&l.layer.layertype=="JOIN"){FM.SpatialQuery.getFeatureInfoJoin(l,e.layerPoint,e.latlng,fenixMap.map)}else{FM.SpatialQuery.getFeatureInfoStandard(l,e.layerPoint,e.latlng,fenixMap.map)}}},addClickEffect:function(latlng,map){var html='<div id="reveal-cards">'+'<div class="cards-card">'+'<div style="clear:both"></div></div>';L.marker([latlng.lat,latlng.lng],{icon:L.divIcon({html:html,iconSize:[40,40]})}).addTo(map)},zoomTo:function(boundary,code,srs){FM.LayerUtils.zoomToBoundary(this.map,boundary,code,srs)},zoomTo:function(boundary,code){FM.LayerUtils.zoomToBoundary(this.map,boundary,code,"EPSG:3827")},invalidateSize:function(){this.map.invalidateSize()},initializeMapGUI:function(){if(this.options.gui!=null){var _this=this;$.each(this.options.gui,function(key,value){var invoke="_add"+key.toLowerCase();try{if(FM.Plugins[invoke])FM.Plugins[invoke](_this,value)}catch(e){throw new Error("Plugin: "+invoke+" doesn't exist")}})}},initializePlugins:function(){if(this.options.plugins!=null){var _this=this;$.each(this.options.plugins,function(key,value){var invoke="_add"+key.toLowerCase();FM.loadModuleLibs(key.toLowerCase(),function(){FM.Plugins[invoke](_this,value)})})}},cloneMap:function(id){var exportedMap=this.exportMap();var v=JSON.stringify(exportedMap.layers,function(key,val){if(typeof val==="function"){return val+""}return val});var clonedMap=new FM.Map(id,exportedMap.map.options,exportedMap.map.mapOptions);clonedMap.createMap();clonedMap.createMapFromJSON(exportedMap);return clonedMap},createMapFromJSON:function(json){this.loadOverlays(json.layers.overlays)},exportMap:function(){var o={};o.map=this._getMapOptions();o.layers=this._getMapLayers();return o},exportMapToJSONFile:function(){var json=this.exportMap();var id=FM.Util.randomID();var uriContent="data:application/octet-stream;filename=mapview-"+id+".fnx,"+encodeURIComponent(JSON.stringify(json));var _window=window.open(uriContent,"mapview-"+id+".fnx");_window.focus()},_getMapOptions:function(){var o={options:{},mapOptions:{}};o.options=$.extend(true,{},this.options);o.mapOptions=$.extend(true,{},this.mapOptions);this._getCurrentMapOptions(o.mapOptions);return o},_getCurrentMapOptions:function(mapOptions){mapOptions.lat=this.map.getCenter().lat;mapOptions.lng=this.map.getCenter().lng;mapOptions.zoom=this.map.getZoom()},_getMapLayers:function(){var o={};o.overlays=this.controller.exportOverlays();return o},loadOverlays:function(overlays){for(var i=0;i<overlays.length;i++){var l=new FM.layer(overlays[i]);this.addLayer(l)}}});FM.map=function(id,options,mapOptions){return new FM.Map(id,options,mapOptions)};FM.LayerLegend={getLegend:function(l,toRendedID,isReload){$("#"+toRendedID+"-legend-layertitle").empty();$("#"+toRendedID+"-legendtitle").empty();$("#"+toRendedID+"-legendsubtitle").empty();$("#"+toRendedID+"-content").empty();if(l.layer.layertitle){$("#"+toRendedID+"-legend-layertitle").append(l.layer.layertitle)}if(l.layer.legendtitle){$("#"+toRendedID+"-legendtitle").append(l.layer.legendtitle)}if(l.layer.legendsubtitle){$("#"+toRendedID+"-legendsubtitle").append(l.layer.legendsubtitle)}var html="";if(l.layer.legendHTML){html=l.layer.legendHTML;$("#"+toRendedID+"-content").append(html)}else{var url=l.layer.urlWMS+"?";url+="&service=WMS"+"&version=1.1.0"+"&REQUEST=GetLegendGraphic"+"&layer="+l.layer.layers+"&Format=image/png";if(l.layer.style!=null&&l.layer.style!="")url+="&style="+l.layer.style;if(l.layer.sldurl)url+="&sld="+l.layer.sldurl;var alternativeUrl=url;url+="&LEGEND_OPTIONS=forceLabels:on;forceRule:True;dx:0;dy:0;mx:0;my:0;border:false;fontAntiAliasing:true;fontColor:0x47576F;fontSize:10;bgColor:0xF9F7F3";FM.LayerLegend._loadLegend(url,alternativeUrl,toRendedID)}if(isReload){if($("#"+toRendedID+"-holder").is(":visible")){$("#"+toRendedID+"-holder").hide();$("#"+toRendedID+"-holder").slideDown();l.layer.openlegend=true}else{}}else{if(!$("#"+toRendedID+"-holder").is(":visible")){$("#"+toRendedID+"-holder").slideDown();l.layer.openlegend=true}else{$("#"+toRendedID+"-holder").slideUp();l.layer.openlegend=false}}$("#"+toRendedID+"-remove").click({id:toRendedID+"-holder"},function(event){$("#"+event.data.id).slideUp();l.layer.openlegend=false})},_loadLegend:function(url,alternativeUrl,toRendedID){var img=new Image;img.name=url;img.src=url;var html='<img id="'+toRendedID+'-img" src="'+img.src+'" class="decoded">';img.onload=function(){$("#"+toRendedID+"-content").append(html);$("#"+toRendedID+"-img").css("width",this.width);$("#"+toRendedID+"-img").css("height",this.height)};img.onerror=function(){if(alternativeUrl)FM.LayerLegend._loadLegend(alternativeUrl,null,toRendedID);else FM.LayerLegend._nolegend(toRendedID)}},_nolegend:function(toRendedID){var html='<div class="fm-legend-layertitle">'+$.i18n.prop("_nolegendavailable")+"</div>";$("#"+toRendedID+"-content").append(html)}};FM.MAPController=FM.Class.extend({id:"",suffix:"",_map:"",_fenixMap:"",_guiController:{overlay:true,baselayer:true},baseLayersMap:"",currentBaseLayer:"",layersMap:"",layersMapZIndexes:"",zIndexBaseLayer:10,zIndex:100,selectedLayer:"",$boxIcons:"",$menuBox:"",$menuBoxContainer:"",$selectedMenuBox:"",getFeautureInfoLayer:[],initialize:function(suffix,fenixMap,map,guiController){this._map=map;this._fenixMap=fenixMap;this.suffix=suffix;this.id=suffix+"-controller";this._guiController=$.extend({},this._guiController,guiController);this.baseLayersMap=new HashMap;this.layersMap=new HashMap;this.layersMapZIndexes=new HashMap},initializeGUI:function(){if(this._guiController){$("#"+this.id).append(FM.replaceAll(FM.guiController.box,"REPLACE",this.suffix));$("#"+this.id).append(FM.replaceAll(FM.guiController.boxIcons,"REPLACE",this.suffix));this.$menuBox=$("#"+this.suffix+"-controller-box");this.$menuBoxContainer=$("#"+this.suffix+"-controller-box-content");this.$boxIcons=$("#"+this.suffix+"-controller-box-icons-container");this.$boxIcons;if(this._guiController.overlay){this.loadIcon("overlay");this.initializeOverlayDragging()}if(this._guiController.baselayer){this.loadIcon("baselayer")}if(this._guiController.wmsLoader){this.loadIcon("wmsLoader");var wmsUtils=new FM.WMSUtils;var idDD=this.suffix+"-controller-wmsLoader-dropdown";var idContent=this.suffix+"-controller-wmsLoader-content";var wmsServers=FM.WMSSERVERS.DEFAULT_EXTERNAL_WMS_SERVERS;wmsUtils.WMSCapabilities(idDD,idContent,this._fenixMap,wmsServers)}}},loadIcon:function(toLoad){var guiController=FM.guiController;var guiBox=toLoad+"Box";var guiIcon=toLoad+"Icon";this.$boxIcons.show();this.$boxIcons.append(FM.replaceAll(guiController[guiIcon],"REPLACE",this.suffix));this.$menuBoxContainer.append(FM.replaceAll(guiController[guiBox],"REPLACE",this.suffix));var boxIcon=$("#"+this.suffix+"-controller-"+toLoad+"Icon");boxIcon.attr("title",$.i18n.prop("_"+toLoad));try{boxIcon.powerTip({placement:"ne"})}catch(e){}var _this=this;var $id=$("#"+_this.suffix+"-controller-"+toLoad+"-box");$("#"+this.suffix+"-controller-"+toLoad+"Icon").click({$id:$id,suffix:this.suffix},function(event){var $id=event.data.$id;var suffix=event.data.suffix;if(_this.$menuBox.is(":visible")){if(_this.$selectedMenuBox==$id){_this.$menuBox.slideUp("slow");$id.hide();_this.$selectedMenuBox=""}else{_this.$selectedMenuBox.hide();$id.slideDown("slow");_this.$selectedMenuBox=$id}}else{_this.$selectedMenuBox=$id;_this.$selectedMenuBox.show();_this.$menuBox.slideDown("slow",function(){})}});$("#"+this.suffix+"-controller-"+toLoad+"-remove").click({$id:$id,suffix:this.suffix},function(event){var $id=event.data.$id;var suffix=event.data.suffix;$("#"+suffix+"-controller-box").slideUp("slow");$id.hide()})},initializeOverlayDragging:function(){var _this=this;$("#"+this.suffix+"-controller-overlay-content").sortable({cursor:"move",opacity:"0.5",start:function(event,ui){},stop:function(event,ui){var children=$(ui.item).parent().children();var layerIDs=[];var zIndexBase=0;for(var i=children.length-1;i>=0;i--){var id=$(children[i]).data("layer").id;var layertitle=$(children[i]).data("layer").layer.layertitle;var zIndex=zIndexBase+100;layerIDs.push($(children[i]).data("layer").id);_this.updateZIndex(id,zIndex);zIndexBase++}}})},layerAdded:function(l){l.layerAdded=true;if(!l.layer.zindex){l.layer.zindex=this.zIndex;l.leafletLayer.setZIndex=l.layer.zindex}this.zIndex=this.zIndex+2;if(l.layer.hideLayerInControllerList){}else{var legendStructure=FM.replaceAll(FM.guiController.legend,"REPLACE",l.id);var idMap="#"+this.suffix+"-container-map";$(idMap).append(legendStructure);var idStructure="#"+this.suffix+"-controller-overlay-content";var idItem="#"+l.id+"-controller-item";var idControllerItem=l.id+"-controller-item";var overlayStructure=FM.replaceAll(FM.guiController.overlay,"REPLACE",l.id);$(idStructure).prepend(overlayStructure);$("#"+l.id+"-controller-item-box").data("layer",l);var index=$("#"+l.id+"-controller-item-box").index()+1;this._layerGUIOptions(l);this.layersMap.set(l.id,l);this.layersMapZIndexes.set(l.layer.zindex,l.id);$(idItem).attr("title",$.i18n.prop("_dragdroplayer"));try{$(idItem).powerTip({placement:"e"})}catch(e){}var _this=this;$(idItem+"-title").append(l.layer.layertitle);$(idItem+"-title").attr("title",l.layer.layertitle);try{$(idItem+"-title").powerTip({placement:"se"})}catch(e){}var $removeLayer=$(idItem+"-remove");$removeLayer.click({l:l},function(event){event.stopPropagation();if(confirm($.i18n.prop("_confirmremovelayer"))){_this.removeLayer(event.data.l)}event.preventDefault()});$removeLayer.attr("title",$.i18n.prop("_removelayer"));try{removeLayer.powerTip({placement:"n"})}catch(e){}var $enabledisablelayer=$(idItem+"-enabledisable");$enabledisablelayer.click({id:l.id},function(event){_this.showHide(event.data.id)});$enabledisablelayer.attr("title",$.i18n.prop("_enabledisablelayer"));try{$enabledisablelayer.powerTip({placement:"se"})}catch(e){}var opacity=1;if(l.layer.opacity!=null)opacity=l.layer.opacity;try{var $layeropacity=$(idItem+"-opacity");$layeropacity.slider({orientation:"horizontal",range:"min",min:0,max:1,step:.1,value:opacity,slide:function(event,ui){FM.LayerUtils.setLayerOpacity(l,ui.value)}});$layeropacity.attr("title",$.i18n.prop("_layeropacity"));try{$layeropacity.powerTip({placement:"se"})}catch(e){}}catch(e){}var $layergfi=$(idItem+"-getfeatureinfo");if(!l.layer.enablegfi)$(idItem+"-getfeatureinfo").css("display","none");else{$layergfi.click({id:l.id},function(event){var l=_this.layersMap.get(event.data.id);if(_this.selectedLayer.id==event.data.id){$("#"+_this.selectedLayer.id+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected");_this.selectedLayer="";l.layer.defaultgfi=false}else{$("#"+_this.selectedLayer.id+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected");$("#"+event.data.id+"-controller-item-getfeatureinfo").addClass("fm-icon-getfeatureinfo-selected");_this.selectedLayer=l;l.layer.defaultgfi=true}});$layergfi.attr("title",$.i18n.prop("_getfeatureinfo"));try{$layergfi.powerTip({placement:"se"})}catch(e){}if(l.layer.defaultgfi){this.selectedLayer=l;$("#"+this.selectedLayer.id+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected");$("#"+l.id+"-controller-item-getfeatureinfo").addClass("fm-icon-getfeatureinfo-selected")}}var $getlegend=$(idItem+"-getlegend");if(l.layer.showlegend==null||l.layer.showlegend!=false){$getlegend.click({id:l.id,idToRender:idControllerItem+"-getlegend"},function(event){var l=_this.layersMap.get(event.data.id);FM.LayerLegend.getLegend(l,event.data.idToRender)})}$getlegend.attr("title",$.i18n.prop("_showhidelegend"));try{$getlegend.powerTip({placement:"se"})}catch(e){}$getlegend.css("display","inline-block");if(l.layer.layertype){if(l.layer.layertype=="JOIN"){if(l.layer.switchjointype==null||l.layer.switchjointype){$(idItem+"-switchjointype").css("display","inline-block");$(idItem+"-switchjointype").click({id:l.id},function(event){_this.switchJoinType(event.data.id)});if(l.layer.jointype.toLowerCase()=="point"){$(idItem+"-switchjointype").attr("title",$.i18n.prop("_switchtoshaded"))}else if(l.layer.jointype.toLowerCase()=="shaded"){$(idItem+"-switchjointype").attr("title",$.i18n.prop("_switchtopoint"))}try{$(idItem+"-switchjointype").powerTip({placement:"se"})}catch(e){}}}}var $swipelayer=$(idItem+"-swipe");$swipelayer.click({id:l.id},function(event){var l=_this.layersMap.get(event.data.id);if(l.layer.swipeActive==null||!l.layer.swipeActive){FM.LayerSwipe.swipeActivate(l,_this._fenixMap.suffix+"-handle",_this._fenixMap.suffix+"-map",_this._map);$swipelayer.addClass("fm-icon-swipe-selected")}else{FM.LayerSwipe.swipeDeactivate(l,_this._map);$swipelayer.removeClass("fm-icon-swipe-selected")}});var $zoomtolayer=$(idItem+"-zoomtolayer");if(l.layer.zoomToBBOX){$zoomtolayer.css("display","inline-block");$zoomtolayer.attr("title",$.i18n.prop("_zoomtolayer"));$zoomtolayer.click({id:l.id},function(event){var l=_this.layersMap.get(event.data.id);FM.LayerUtils.zoomToLayer(_this._map,l.layer)})}if(l.layer.zoomTo){$zoomtolayer.css("display","inline-block");$zoomtolayer.attr("title",$.i18n.prop("_zoomtolayer"));$zoomtolayer.click({id:l.id},function(event){var l=_this.layersMap.get(event.data.id);FM.LayerUtils.zoomToLayer(_this._map,l.layer)})}var $subiconsshowhide=$(idItem+"-showhide-subicons");var $subiconscontainer=$(idItem+"-subicons");$subiconsshowhide.click(function(event){$subiconscontainer.slideToggle();if($subiconsshowhide.hasClass("fm-icon-up")){$subiconsshowhide.removeClass("fm-icon-up");$subiconsshowhide.addClass("fm-icon-down")}else{$subiconsshowhide.removeClass("fm-icon-down");$subiconsshowhide.addClass("fm-icon-up")}});$subiconsshowhide.attr("title",$.i18n.prop("_layersubicons"));try{$subiconsshowhide.powerTip({placement:"n"})}catch(e){}}},_layerGUIOptions:function(l){var gui=l.gui;if(l.layer.layertype=="JOIN"){if(l.layer.gui!=null)if(l.layer.gui.nojoinlayerswitch!=null&&l.layer.gui.nojoinlayerswitch){$("#"+l.id+"-controller-item-switchjointype").css("display","none")}}},addBaseLayer:function(l){l.layer.zindex=this.zIndexBaseLayer;this.zIndexBaseLayer=this.zIndexBaseLayer+2;this.baseLayersMap.set(l.id,l);this.layersMapZIndexes.set(l.layer.zindex,l.id);var idStructure="#"+this.suffix+"-controller-baselayer-content";var idItem="#"+l.id+"-controller-item";var overlayStructure=FM.replaceAll(FM.guiController.baselayer,"REPLACE",l.id);overlayStructure=FM.replaceAll(overlayStructure,"MAPID",this._fenixMap.id);$(idStructure).append(overlayStructure);var _this=this;$(idItem+"-title").append(l.layer.layertitle);$("#"+l.id+"-controller-item-baselayer-image").addClass("fm-icon-baselayer-"+l.layer.layername);$(idItem+"-enabledisable").click({id:l.id},function(event){_this.showHide(event.data.id)});var opacity=1;if(l.layer.opacity!=null)opacity=l.layer.opacity;try{$(idItem+"-opacity").slider({orientation:"horizontal",range:"min",min:0,max:1,step:.1,value:opacity,slide:function(event,ui){FM.LayerUtils.setLayerOpacity(l,ui.value)}})}catch(e){}$("#"+l.id+"-controller-box-item").click({id:l.id},function(event){var id=event.data.id;var l=_this.baseLayersMap.get(id);_this.removeBaseLayerByID(_this.currentBaseLayer.id);var oldBaseLayer=_this.baseLayersMap.get(_this.currentBaseLayer.id);$("#"+oldBaseLayer.id+"-controller-box-item").removeClass("fm-controller-box-item-baselayer-content-selected");$("#"+oldBaseLayer.id+"-controller-item-opacity").hide();$("#"+l.id+"-controller-box-item").addClass("fm-controller-box-item-baselayer-content-selected");$("#"+l.id+"-controller-item-opacity").show();_this._map.addLayer(l.leafletLayer);_this.currentBaseLayer=l;_this.setZIndex(l)});if(this.baseLayersMap.count()==1){$(idItem+"-radio").attr("checked",true);this._map.addLayer(l.leafletLayer);this.currentBaseLayer=l;$("#"+l.id+"-controller-box-item").addClass("fm-controller-box-item-baselayer-content-selected");$("#"+l.id+"-controller-item-opacity").show();_this.setZIndex(l)}},removeLayer:function(l){if(l.layer.jointype!=null&&l.layer.jointype=="point")this.removeLayerPoint(l);else this.removeLayerDefault(l)},removeLayerDefault:function(l){this._map.removeLayer(l.leafletLayer);this.layersMap.remove(l.id);this.layersMapZIndexes.remove(l.layer.zindex);$("#"+l.id+"-controller-item-box").remove();$("#"+l.id+"-controller-item-getlegend-holder").remove()},removeLayerPoint:function(l){for(var i=0;i<l.layer.pointsLayers.length;i++)this._map.removeLayer(l.layer.pointsLayers[i]);this.layersMap.remove(l.id);this.layersMapZIndexes.remove(l.layer.zindex);$("#"+id+"-controller-item-box").remove()},removeBaseLayerByID:function(id){var l=this.baseLayersMap.get(id);this._map.removeLayer(l.leafletLayer)},switchJoinType:function(id){var l=this.layersMap.get(id);try{$.powerTip.destroy($("#"+l.id+"-controller-item-switchjointype"))}catch(e){}if(l.layer.jointype.toLowerCase()=="point"){$("#"+l.id+"-controller-item-switchjointype").attr("title",$.i18n.prop("_switchtopoint"));this.switchToShaded(id)}else if(l.layer.jointype.toLowerCase()=="shaded"){$("#"+l.id+"-controller-item-switchjointype").attr("title",$.i18n.prop("_switchtoshaded"));this.switchToPoint(id)}try{$("#"+l.id+"-controller-item-switchjointype").powerTip({placement:"se"})}catch(e){}},switchToPointswitchToPoint:function(id){var l=this.layersMap.get(id);l.layer.jointype="point";if(l.leafletLayer!=null)this._map.removeLayer(l.leafletLayer);this._fenixMap.createPointLayerRequest(l)},switchToShaded:function(id){var l=this.layersMap.get(id);l.layer.jointype="shaded";if(l.layer.pointsLayers!=null){for(var i=0;i<l.layer.pointsLayers.length;i++){this._map.removeLayer(l.layer.pointsLayers[i])}}this._fenixMap.createShadeLayerRequest(l)},showHide:function(id,isReload){var l=this.layersMap.get(id);if(l.layer.jointype&&l.layer.jointype.toLowerCase()=="point")this.showHidePointLayer(id);else this.showHideLayer(id,isReload)},showHidePointLayer:function(id){var l=this.layersMap.get(id);for(var i=0;i<l.layer.pointsLayers.length;i++){if(l.layer.visibility==null||l.layer.visibility){l.layer.visibility=false;$("#"+id+"-controller-item-enabledisable").removeClass("fm-icon-enable");$("#"+id+"-controller-item-enabledisable").addClass("fm-icon-disable");for(var i=0;i<l.layer.pointsLayers.length;i++)this._map.removeLayer(l.layer.pointsLayers[i])}else{l.layer.visibility=true;$("#"+id+"-controller-item-enabledisable").removeClass("fm-icon-disable");$("#"+id+"-controller-item-enabledisable").addClass("fm-icon-enable");for(var i=0;i<l.layer.pointsLayers.length;i++)this._map.addLayer(l.layer.pointsLayers[i])}}},showHideLayer:function(id,isReload){var l=this.layersMap.get(id);if(isReload!=null&&!isReload){if(l.layer.visibility==false){$("#"+id+"-controller-item-enabledisable").removeClass("fm-icon-enable");$("#"+id+"-controller-item-enabledisable").addClass("fm-icon-disable");this._map.removeLayer(l.leafletLayer)}}else if(isReload!=null&&isReload){}else{if(l.layer.visibility==null||l.layer.visibility){l.layer.visibility=false;$("#"+id+"-controller-item-enabledisable").removeClass("fm-icon-enable");$("#"+id+"-controller-item-enabledisable").addClass("fm-icon-disable");this._map.removeLayer(l.leafletLayer)}else{l.layer.visibility=true;$("#"+id+"-controller-item-enabledisable").removeClass("fm-icon-disable");$("#"+id+"-controller-item-enabledisable").addClass("fm-icon-enable");this._map.addLayer(l.leafletLayer);this.setZIndex(l)}}},updateZIndex:function(layerID,updatedZIndex){var l=this.layersMap.get(layerID);l.layer.zindex=updatedZIndex;l.leafletLayer.setZindex=updatedZIndex;try{document.getElementById(l.id).style.zIndex=updatedZIndex}catch(e){console.log("error updateZIndex: "+l.id+" doesnt exists")}},setZIndex:function(l){var layers=document.getElementById(this._fenixMap.tilePaneID).childNodes;for(i=0,len=layers.length;i<len;i++){if(layers[i]!==this._container){var zIndex=parseInt(layers[i].style.zIndex,10);if(isNaN(zIndex)){layers[i].style.zIndex=l.layer.zindex;layers[i].id=l.id}}}},selectGetFeatureInfoIcon:function(id){for(var i=0;i<this.layersMap.count();i++){if(this.layersMap._data[i]==id)$("#"+id+"-controller-item-getfeatureinfo").addClass("fm-icon-getfeatureinfo-selected");else $("#"+id+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected")}},exportOverlays:function(){console.log("exportOverlays");var arrayZindex=[];this.layersMap.forEach(function(l){arrayZindex.push(l.layer.zindex)});arrayZindex=arrayZindex.sort();console.log(arrayZindex);var arrayLayers=[];for(var i=0;i<arrayZindex.length;i++){var found=false;if(!found)this.layersMap.forEach(function(l){if(l.layer.zindex==arrayZindex[i]){arrayLayers.push(l.layer);found=true}})}var clonedArray=$.map(arrayLayers,function(obj){return $.extend(true,{},obj)});return clonedArray},exportBaselayers:function(){return null},updateZindexCounter:function(){}});FM.mapController=function(suffix,fenixMap,map,guiController){return new FM.MAPController(suffix,fenixMap,map,guiController)};FM.LayerLegend={getLegend:function(l,toRendedID,isReload){$("#"+toRendedID+"-legend-layertitle").empty();$("#"+toRendedID+"-legendtitle").empty();$("#"+toRendedID+"-legendsubtitle").empty();$("#"+toRendedID+"-content").empty();if(l.layer.layertitle){$("#"+toRendedID+"-legend-layertitle").append(l.layer.layertitle)}if(l.layer.legendtitle){$("#"+toRendedID+"-legendtitle").append(l.layer.legendtitle)}if(l.layer.legendsubtitle){$("#"+toRendedID+"-legendsubtitle").append(l.layer.legendsubtitle)}var html="";if(l.layer.legendHTML){html=l.layer.legendHTML;$("#"+toRendedID+"-content").append(html)}else{var url=l.layer.urlWMS+"?";url+="&service=WMS"+"&version=1.1.0"+"&REQUEST=GetLegendGraphic"+"&layer="+l.layer.layers+"&Format=image/png";if(l.layer.style!=null&&l.layer.style!="")url+="&style="+l.layer.style;if(l.layer.sldurl)url+="&sld="+l.layer.sldurl;var alternativeUrl=url;url+="&LEGEND_OPTIONS=forceLabels:on;forceRule:True;dx:0;dy:0;mx:0;my:0;border:false;fontAntiAliasing:true;fontColor:0x47576F;fontSize:10;bgColor:0xF9F7F3";FM.LayerLegend._loadLegend(url,alternativeUrl,toRendedID)}if(isReload){if($("#"+toRendedID+"-holder").is(":visible")){$("#"+toRendedID+"-holder").hide();$("#"+toRendedID+"-holder").slideDown();l.layer.openlegend=true}else{}}else{if(!$("#"+toRendedID+"-holder").is(":visible")){$("#"+toRendedID+"-holder").slideDown();l.layer.openlegend=true}else{$("#"+toRendedID+"-holder").slideUp();l.layer.openlegend=false}}$("#"+toRendedID+"-remove").click({id:toRendedID+"-holder"},function(event){$("#"+event.data.id).slideUp();l.layer.openlegend=false})},_loadLegend:function(url,alternativeUrl,toRendedID){var img=new Image;img.name=url;img.src=url;var html='<img id="'+toRendedID+'-img" src="'+img.src+'" class="decoded">';img.onload=function(){$("#"+toRendedID+"-content").append(html);$("#"+toRendedID+"-img").css("width",this.width);$("#"+toRendedID+"-img").css("height",this.height)};img.onerror=function(){if(alternativeUrl)FM.LayerLegend._loadLegend(alternativeUrl,null,toRendedID);else FM.LayerLegend._nolegend(toRendedID)}},_nolegend:function(toRendedID){var html='<div class="fm-legend-layertitle">'+$.i18n.prop("_nolegendavailable")+"</div>";$("#"+toRendedID+"-content").append(html)}};FM.LayerSwipe={swipeActivate:function(l,handleID,containerID,map){l.layer.swipeActive=true;var l_parent=l.leafletLayer._container,handle=document.getElementById(handleID),dragging=false;handle.onmousedown=function(){dragging=true;return false};document.onmouseup=function(){dragging=false};document.onmousemove=function(e){if(!dragging)return;setDivide(e.x)};var _this=this;l.redraw=function(e){l_parent=l.leafletLayer._container;setDivide(parseInt(handle.style.left))};l.mousemoveSwipe=function(e){l_parent=l.leafletLayer._container;setDivide(e.containerPoint.x)};map.on("zoomend",l.redraw);map.on("moveend",l.redraw);map.on("drag",l.redraw);map.on("mousemove",l.mousemoveSwipe);function setDivide(x){x=Math.max(0,Math.min(x,map.getSize()["x"]));handle.style.left=x+"px";var layerX=map.containerPointToLayerPoint(x,0).x;l_parent.style.clip="rect(-99999px "+layerX+"px 999999px -99999px)"}var mydiv=$("#"+containerID).width();setDivide(mydiv/2)},swipeDeactivate:function(l,map){map.off("zoomend",l.redraw);map.off("moveend",l.redraw);map.off("drag",l.redraw);map.off("mousemove",l.mousemoveSwipe);l.layer.swipeActive=false;var l_parent=l.leafletLayer._container;l_parent.style.clip="auto"}};FM.LayerUtils={zoomToLayer:function(map,layer){if(layer.bbox)FM.LayerUtils.zoomTOBBOX(map,layer.bbox);else if(layer.zoomTo)FM.LayerUtils.zoomToBoundary(map,layer.zoomTo.boundary,layer.zoomTo.code,layer.zoomTo.srs)},zoomToBoundary:function(map,boundary,code,srs){FM.LayerUtils._zoomToRequest(map,boundary,code,srs)},zoomTOBBOX:function(map,bbox){var bounds;if(bbox.ymin){var southWest=new L.LatLng(bbox.ymin,bbox.xmin);var northEast=new L.LatLng(bbox.ymax,bbox.xmax);bounds=new L.LatLngBounds(southWest,northEast)}else if(bbox){if(bbox.length>0){var southWest=new L.LatLng(bbox[0],bbox[1]);var northEast=new L.LatLng(bbox[2],bbox[3]);bounds=new L.LatLngBounds(southWest,northEast)}}if(bounds)FM.LayerUtils.zoomToBounds(map,bounds)},zoomToBounds:function(map,bounds){map.fitBounds(bounds)},_zoomToRequest:function(map,boundary,code,srs){var _this=this;var url=FMCONFIG.BASEURL_MAPS+FMCONFIG.MAP_SERVICE_ZOOM_TO_BOUNDARY+"/"+boundary+"/"+code+"/"+srs+"";var xhr=new RequestHandler;xhr.open("GET",url);xhr.setContentType("application/x-www-form-urlencoded");xhr.request.onload=function(){var response=this.responseText;if(typeof response=="string")response=$.parseJSON(response);var southWest=new L.LatLng(response.ymin,response.xmin);var northEast=new L.LatLng(response.ymax,response.xmax);var bounds=new L.LatLngBounds(southWest,northEast);map.fitBounds(bounds)};xhr.send(null)},setLayerOpacity:function(l,opacity){if(l.leafletLayer)l.leafletLayer.setOpacity(opacity);l.layer.opacity=opacity;l.leafletLayer.options.opacity=opacity},filterLayerMinEqualThan:function(fenixMap,l,value){l=FM.LayerUtils.getValuesMinEqualThan(l,value);FM.LayerUtils._refreshLayer(fenixMap,l)},filterLayerGreaterEqualThan:function(fenixMap,l,value){l=FM.LayerUtils.getValuesGreaterEqualThan(l,value);FM.LayerUtils._refreshLayer(fenixMap,l)},filterLayerInBetweenEqualThan:function(fenixMap,l,min,max){l=FM.LayerUtils.getValuesInBetweenEqualThan(l,min,max);FM.LayerUtils._refreshLayer(fenixMap,l)},filterLayerOuterEqualThan:function(fenixMap,l,min,max){l=FM.LayerUtils.getValuesOuterEqualThan(l,min,max);FM.LayerUtils._refreshLayer(fenixMap,l)},_refreshLayer:function(fenixMap,l){switch(l.layer.jointype){case"point":fenixMap.createPointLayerRequest(l);break;case"shaded":fenixMap.createShadeLayerRequest(l,true);break}},getValuesMinEqualThan:function(l,value){if(typeof l.layer.defaultdata=="string")l.layer.defaultdata=$.parseJSON(l.layer.defaultdata);l.layer.joindata=[];for(i=0;i<l.layer.defaultdata.length;i++){$.each(l.layer.defaultdata[i],function(k,v){if(v<=value){l.layer.joindata.push(l.layer.defaultdata[i])}})}l.layer.joindata=JSON.stringify(l.layer.joindata);return l},getValuesGreaterEqualThan:function(l,value){if(typeof l.layer.defaultdata=="string")l.layer.defaultdata=$.parseJSON(l.layer.defaultdata);l.layer.joindata=[];for(i=0;i<l.layer.defaultdata.length;i++){$.each(l.layer.defaultdata[i],function(k,v){if(v>=value){l.layer.joindata.push(l.layer.defaultdata[i])}})}l.layer.joindata=JSON.stringify(l.layer.joindata);return l},getValuesInBetweenEqualThan:function(l,min,max){if(typeof l.layer.defaultdata=="string")l.layer.defaultdata=$.parseJSON(l.layer.defaultdata);l.layer.joindata=[];for(i=0;i<l.layer.defaultdata.length;i++){$.each(l.layer.defaultdata[i],function(k,v){if(v>=min&&v<=max){l.layer.joindata.push(l.layer.defaultdata[i])}})}l.layer.joindata=JSON.stringify(l.layer.joindata);return l},getValuesOuterEqualThan:function(l,min,max){if(typeof l.layer.defaultdata=="string")l.layer.defaultdata=$.parseJSON(l.layer.defaultdata);l.layer.joindata=[];for(i=0;i<l.layer.defaultdata.length;i++){$.each(l.layer.defaultdata[i],function(k,v){if(min&&v<=min||max&&v>=max){l.layer.joindata.push(l.layer.defaultdata[i])}})}l.layer.joindata=JSON.stringify(l.layer.joindata);return l}};FM.MapUtils=function(){var syncMapsOnMove=function(map,mapToSync){var m=map.map?map.map:map;var mToSync=mapToSync.map?mapToSync.map:mapToSync;m.on("dragend zoomend",function(e){if(m.getCenter()!=mToSync.getCenter&&m.getZoom()!=mToSync.getZoom){mToSync.setView(m.getCenter(),m.getZoom())}})};var exportLayers=function(fenixmap){};return{syncMapsOnMove:syncMapsOnMove,exportLayers:exportLayers}}();FM.Plugins={_addfullscreen:function(_fenixmap,show){if(show){console.log(_fenixmap.options.gui.fullscreenID);$("#"+_fenixmap.mapContainerID).append("<div class='fm-icon-box-background fm-btn-icon fm-fullscreen'><div class='fm-icon-sprite fm-icon-fullscreen' id='"+_fenixmap.suffix+"-fullscreenBtn'><div></div>");FM.UIUtils.fullscreen(_fenixmap.suffix+"-fullscreenBtn",_fenixmap.options.gui.fullscreenID)}},_addlayercontroller:function(_fenixmap,show){if(show)$("#"+this.suffix+"-controller").show();else $("#"+this.suffix+"-controller").hide()},_addgeosearch:function(_fenixmap,show){if(show){new L.Control.GeoSearch({provider:new L.GeoSearch.Provider.OpenStreetMap}).addTo(_fenixmap.map)}},_addgeocoder:function(_fenixmap,show){if(show){var osmGeocoder=new L.Control.OSMGeocoder;_fenixmap.map.addControl(osmGeocoder)}},_addmouseposition:function(_fenixmap,show){if(show){L.control.mousePosition().addTo(_fenixmap.map)}},_addexport:function(_fenixmap,show){if(show){_fenixmap.map.addControl(new L.Control.Export)}},_addzoomcontrol:function(_fenixmap,position){var zoomControl=new L.Control.Zoom;zoomControl.setPosition("bottomright");_fenixmap.map.addControl(zoomControl)},_addprintmodule:function(_fenixmap,show){if(show)var printProvider=L.print.provider({method:"GET",url:"http://hqlprfenixapp1.hq.un.fao.org:10090/geoserver/pdf",autoLoad:true,dpi:254});var printControl=L.control.print({provider:printProvider});_fenixmap.map.addControl(printControl)},_adddisclaimerfao:function(_fenixmap,show){if(show){var structure=FM.replaceAll(FM.guiMap.disclaimerfao,"REPLACE",_fenixmap.suffix);$("#"+_fenixmap.suffix+"-container-map").append(structure);var text="";switch(_fenixmap.options.lang.toUpperCase()){case"ES":text=FM.guiMap.disclaimerfao_S;break;case"FR":text=FM.guiMap.disclaimerfao_F;break;default:text=FM.guiMap.disclaimerfao_E;break}text=FM.replaceAll(text,"REPLACE",_fenixmap.suffix);$("#"+_fenixmap.suffix+"-disclaimerfao").attr("title",text);try{$("#"+_fenixmap.suffix+"-disclaimerfao").powerTip({placement:"nw"})}catch(e){}}},_adddrawcontrol:function(_fenixmap,show){if(show){var drawnItems=new L.FeatureGroup;_fenixmap.map.addLayer(drawnItems);var drawControl=new L.Control.Draw({draw:{position:"topleft",polygon:{title:"Draw a polygon!",allowIntersection:false,drawError:{color:"#b00b00",timeout:1e3},shapeOptions:{color:"#bada55"}},circle:{shapeOptions:{color:"#662d91"}}},edit:{featureGroup:drawnItems}});_fenixmap.map.addControl(drawControl);_fenixmap.map.on("draw:created",function(e){var type=e.layerType,layer=e.layer;
if(type==="marker"){layer.bindPopup("A popup!")}l=layer;l.layerType=type;drawnItems.addLayer(layer);_fenixmap.spatialQuery(layer)});_fenixmap.map.on("draw:edited",function(e){var layers=e.layers;var countOfEditedLayers=0;layers.eachLayer(function(layer){countOfEditedLayers++})})}},_addcontrolloading:function(_fenixmap,show){if(show){var loadingControl=L.Control.loading({separate:true,position:"topright"});_fenixmap.map.addControl(loadingControl)}}};FM.SpatialQuery={getFeatureInfoJoin:function(l,layerPoint,latlng,map){if(l.layer.custompopup==null)FMDEFAULTLAYER.joinDefaultPopUp(l.layer);FM.SpatialQuery.getFeatureInfoStandard(l,layerPoint,latlng,map)},getFeatureInfoStandard:function(l,layerPoint,latlng,map){var bounds=map.getBounds();var sw=map.options.crs.project(bounds.getSouthWest());var ne=map.options.crs.project(bounds.getNorthEast());var BBOX=sw.x+","+sw.y+","+ne.x+","+ne.y;var WIDTH=map.getSize().x;var HEIGHT=map.getSize().y;var X=map.layerPointToContainerPoint(layerPoint).x;var Y=map.layerPointToContainerPoint(layerPoint).y;X=new Number(X);X=X.toFixed(0);Y=new Number(Y);Y=Y.toFixed(0);var url=FMCONFIG.BASEURL_MAPS+FMCONFIG.MAP_SERVICE_GFI_STANDARD;url+="?SERVICE=WMS";url+="&VERSION=1.1.1";url+="&REQUEST=GetFeatureInfo";url+="&BBOX="+BBOX;url+="&HEIGHT="+HEIGHT;url+="&WIDTH="+WIDTH;url+="&X="+X;url+="&Y="+Y;url+="&FORMAT=image/png";url+="&INFO_FORMAT=text/html";if(l!=""&&l!=null){url+="&LAYERS="+l.layer.layers;url+="&QUERY_LAYERS="+l.layer.layers;url+="&STYLES=";url+="&SRS=EPSG:3857";url+="&urlWMS="+l.layer.urlWMS;FM.SpatialQuery.getFeatureInfoJoinRequest(url,"GET",latlng,map,l)}else{}},getFeatureInfoJoinRequest:function(url,requestType,latlon,map,l){var lang=l.layer.lang?l.layer.lang.toLocaleLowerCase():null;var _map=map;var _l=l;var r=new RequestHandler;r.open(requestType,url);r.setContentType("application/x-www-form-urlencoded");r.onload(function(){var response=this.responseText;if(response!=null){var maxWidth=$("#"+_map._fenixMap.id).width()-15;var maxHeight=$("#"+_map._fenixMap.id).height()-15;var popup=new L.Popup({maxWidth:maxWidth,maxHeight:maxHeight});var r=response;if(_l.layer.customgfi){var result=FM.SpatialQuery.customPopup(response,_l.layer.customgfi,_l.layer.lang,_l.layer.joindata);r=result!=null?result[0]:response}else{var result=FM.SpatialQuery.transposeHTMLTable(response);r=result!=null?result[0]:response}r=FM.SpatialQuery._checkGeoserverDefaultEmptyOutput(r);if(_l.layer.customgfi){if(_l.layer.customgfi&&_l.layer.customgfi.callback)_l.layer.customgfi.callback(r,_l.layer);if(_l.layer.customgfi&&_l.layer.customgfi.output&&_l.layer.customgfi.output.show){$("#"+_l.layer.customgfi.output.id).empty();if(r){$("#"+_l.layer.customgfi.output.id).append(r)}}if(_l.layer.customgfi&&_l.layer.customgfi.showpopup){if(r){popup.setLatLng(latlon).setContent(r);_map.openPopup(popup)}}}else{if(r){popup.setLatLng(latlon).setContent(r);_map.openPopup(popup)}}}});r.send()},customPopup:function(response,custompopup,lang,joindata){var values=this._parseHTML(custompopup.content[lang]);if(values.id.length>0||values.joinid.length>0){var h=$("<div></div>").append(response);var responsetable=h.find("table");if(responsetable){return FM.SpatialQuery._customizePopUp(custompopup.content[lang],values,responsetable,joindata)}}},_checkGeoserverDefaultEmptyOutput:function(response){return response},_customizePopUp:function(content,values,responsetable,joindata){var tableHTML=responsetable.find("tr");var headersHTML=$(tableHTML[0]).find("th");var rowsData=[];var headersHTMLIndexs=[];for(var i=0;i<headersHTML.length;i++){console.log("-----");console.log(headersHTML[i]);for(var j=0;j<values.id.length;j++){console.log(values.id);if(values.id[j].toUpperCase()==headersHTML[i].innerHTML.toUpperCase()){headersHTMLIndexs.push(i);break}}}if(joindata){var headersHTMLJOINIndexs=[];for(var i=0;i<headersHTML.length;i++){for(var j=0;j<values.joinid.length;j++){if(values.joinid[j].toUpperCase()==headersHTML[i].innerHTML.toUpperCase()){headersHTMLJOINIndexs.push(i);break}}}}console.log("headersHTMLJOINIndexs");console.log(headersHTMLJOINIndexs);for(var i=1;i<tableHTML.length;i++){rowsData.push($(tableHTML[i]).find("td"))}var htmlresult=[];console.log("rowsData");console.log(rowsData);for(var j=0;j<rowsData.length;j++){var c=content;for(var i=0;i<headersHTMLIndexs.length;i++){var header="{{"+headersHTML[headersHTMLIndexs[i]].innerHTML+"}}";var d=rowsData[j][headersHTMLIndexs[i]].innerHTML;c=FM.Util.replaceAll(c,header,d)}if(joindata){console.log("headersHTMLJOINIndexs");console.log(headersHTMLJOINIndexs);for(var i=0;i<headersHTMLJOINIndexs.length;i++){console.log(headersHTML[headersHTMLJOINIndexs[i]].innerHTML);var header="{{{"+headersHTML[headersHTMLJOINIndexs[i]].innerHTML+"}}}";console.log("header");console.log(header);var d=rowsData[j][headersHTMLJOINIndexs[i]].innerHTML;var v=FM.SpatialQuery._getJoinValueFromCode(d,joindata);console.log(v);c=FM.Util.replaceAll(c,header,v);console.log(c)}}htmlresult.push(c)}return htmlresult},_getJoinValueFromCode:function(code,joindata){console.log(code);console.log(joindata);var integerCode=parseInt(code)?parseInt(code):null;console.log(integerCode);var json=typeof joindata=="string"?$.parseJSON(joindata):joindata;console.log(json);for(var i=0;i<json.length;i++){if(json[i][code]||json[i][integerCode]){if(json[i][code]){console.log(json[i][code]);return json[i][code]}else{console.log(json[i][integerCode]);return json[i][integerCode]}}}return""},_parseHTML:function(content){var values={};values.id=[];values.joinid=[];var array=content.match(/\{\{.*?\}\}/g);for(var i=0;i<array.length;i++){array[i]=FM.Util.replaceAll(array[i],"{{","");array[i]=FM.Util.replaceAll(array[i],"}}","");if(array[i].indexOf("{")>=0){array[i]=FM.Util.replaceAll(array[i],"{","");array[i]=FM.Util.replaceAll(array[i],"}","");values.joinid.push(array[i])}else{values.id.push(array[i])}}return values},transposeHTMLTable:function(response){var h=$("<div></div>").append(response);var table=h.find("table");var result=[];if(table){var r=FM.SpatialQuery.transposeHTML(table);if(r!=null)return r}return null},transposeHTML:function(table){var div=$('<div class="fm-transpose-popup"></div>');var titleHTML=table.find("caption");try{div.append(titleHTML[0].innerHTML);var tableHTML=table.find("tr");var headers=$(tableHTML[0]).find("th");var rowsData=[];for(var i=1;i<tableHTML.length;i++){rowsData.push($(tableHTML[i]).find("td"))}var t=$("<table></table>");var tb=$("<tbody></tbody>");for(var i=0;i<headers.length;i++){var tr="<tr>";var td="<td>"+headers[i].innerHTML+"</td>";for(var j=0;j<rowsData.length;j++){td+="<td>"+rowsData[j][i].innerHTML+"</td>"}tr+=td;tr+="</tr>";tb.append(tr)}return div.append(t.append(tb))}catch(e){return null}},scatterLayerFilter:function(l,fenixMap,series,xmin,xmax,ymin,ymax,zoomToFeatures,layerHighlight,reclassify){if(!l.leafletLayer||reclassify)l.layer.joindata=[];var spCodes="";for(var i=0;i<series.length;i++){if(series[i].data[0][0]>=xmin&&series[i].data[0][0]<=xmax&&series[i].data[0][1]>=ymin&&series[i].data[0][1]<=ymax){var geocode=series[i].geocode;if(spCodes!="")spCodes+=",";if(geocode)spCodes+="'"+geocode+"'";var s={};var value=series[i].data[0][0]/series[i].data[0][1];s[series[i].geocode]=value;if(!l.leafletLayer||reclassify)l.layer.joindata.push(s)}}if(!l.leafletLayer||reclassify)l.layer.joindata=JSON.stringify(l.layer.joindata);if(l.leafletLayer){if(layerHighlight)FM.SpatialQuery.highlightFeaturesOfLayer(layerHighlight,spCodes);if(reclassify)fenixMap.createShadeLayerRequest(l,true);if(zoomToFeatures){FM.SpatialQuery._sampleSpatialQueryBoundingBox(fenixMap.map,spCodes,l.layer)}}else{fenixMap.addShadedLayer(l)}},scatterLayerFilterFaster:function(l,fenixMap,series,xmin,xmax,ymin,ymax,layerHighlight,reclassify,formula){console.log("----------scatterLayerFilterFaster");console.log(formula);console.log(series);console.log(l);console.log(layerHighlight);var zoomToFeatures=l.layer.zoomToFeatures?l.layer.zoomToFeatures:false;if(!l.leafletLayer||reclassify)l.layer.joindata=[];var spCodes="";for(var i=0;i<series.length;i++){for(var j=0;j<series[i].data.length;j++){if(series[i].data[j].x>=xmin&&series[i].data[j].x<=xmax&&series[i].data[j].y>=ymin&&series[i].data[j].y<=ymax){var code=series[i].data[j].code;if(spCodes!="")spCodes+=",";if(code)spCodes+="'"+code+"'";var s={};if(series[i].data[j].x!=0&&series[i].data[j].y!=0){var value=formula?eval(formula):series[i].data[j].x/series[i].data[j].y;s[series[i].data[j].code]=value;if(!l.leafletLayer||reclassify)l.layer.joindata.push(s)}}}}if(!l.leafletLayer||reclassify)l.layer.joindata=JSON.stringify(l.layer.joindata);if(l.leafletLayer){if(layerHighlight)FM.SpatialQuery.highlightFeaturesOfLayer(layerHighlight,spCodes);if(reclassify)fenixMap.createShadeLayerRequest(l,true);if(zoomToFeatures){FM.SpatialQuery._sampleSpatialQueryBoundingBox(fenixMap.map,spCodes,l.layer)}}else{fenixMap.addShadedLayer(l)}},highlightFeaturesOfLayer:function(l,codes){console.log("highlightFeaturesOfLayer");console.log(l);console.log(codes);var codes=FM.Util.replaceAll(codes,"'","");l.layer.cql_filter=l.layer.joincolumn+" IN ("+codes+")";if(l.layerAdded)l.redraw();else l.addLayerWMS()},_sampleSpatialQueryBoundingBox:function(map,spCodes,layer){var data={};data.datasource="FENIX";var geom=layer.geometrycolumn?layer.geometrycolumn:"geom";data.select="ST_AsText(ST_Transform(ST_Envelope(ST_Collect("+layer.geometrycolumn+")), 4326)) ";data.from=layer.layername?layer.layername:layer.layers;data.where=layer.joincolumn+" IN ("+spCodes+") ";$.ajax({type:"POST",url:FMCONFIG.BASEURL_WDS+FMCONFIG.WDS_SERVICE_SPATIAL_QUERY,data:data,success:function(response){var wkt=new Wkt.Wkt;wkt.read(response);var BBOX={xmin:wkt.components[0][0].x,xmax:wkt.components[0][2].x,ymax:wkt.components[0][1].y,ymin:wkt.components[0][0].y};FM.LayerUtils.zoomTOBBOX(map,BBOX)},error:function(err,b,c){}})},_sampleSpatialQueryCentroid:function(map,spCodes){var data={};data.datasource="FENIX",data.select="ST_AsText(ST_Transform(ST_Centroid(ST_Collect(geom)), 4326)) ";data.from="gaul0_faostat_3857";data.where="faost_code IN ("+spCodes+") ";$.ajax({type:"POST",url:FMCONFIG.BASEURL_WDS+FMCONFIG.WDS_SERVICE_SPATIAL_QUERY,data:data,success:function(response){var wkt=new Wkt.Wkt;wkt.read(response);map.panTo([wkt.components[0].y,wkt.components[0].x])},error:function(err,b,c){}})},filterLayerMinEqualThan:function(l,value){FM.LayerUtils.filterLayerMinEqualThan(this,l,value)},filterLayerGreaterEqualThan:function(l,value){FM.LayerUtils.filterLayerGreaterEqualThan(this,l,value)},filterLayerInBetweenEqualThan:function(l,min,max){FM.LayerUtils.filterLayerInBetweenEqualThan(this,l,min,max)},filterLayerOuterEqualThan:function(l,min,max){FM.LayerUtils.filterLayerOuterEqualThan(this,l,min,max)}};FM.Layer=FM.Class.extend({_fenixmap:"",id:"",layer:{styles:"",srs:"EPSG:3857",visibility:true,format:"image/png",transparent:"TRUE",opacity:1,name:"",tiitle:"","abstract":"",srs:"",LatLonBoundingBox:"",BoundingBox:"",Style:{name:"",title:"","abstract":"",legendurl:{format:"",onlineresource:""}},KeywordList:[],layertitle:"",enablegfi:true,layertype:"WMS",openlegend:false,switchjointype:false,lang:"en"},leafletLayer:"",initialize:function(layer,fenixmap){this.layer=$.extend(true,{},this.layer,layer);this.id=FM.Util.randomID();if(layer.joindata)layer.defaultdata=layer.joindata;if(fenixmap)this._fenixmap=fenixmap},createLayerWMS:function(){var wmsParameters=this._getWMSParameters();if(this.leafletLayer){this.leafletLayer.setParams(wmsParameters)}else{this.leafletLayer=new L.TileLayer.WMS(this.layer.urlWMS,wmsParameters)}return this.leafletLayer},createLayerWMSSLD:function(){var wmsParameters=this._getWMSParameters();if(this.leafletLayer){this.leafletLayer.setParams(wmsParameters)}else{this.leafletLayer=new L.TileLayer.WMS(this.layer.urlWMS,wmsParameters)}return this.leafletLayer},_getWMSParameters:function(){var options={};options.id=this.id;options.layers=this.layer.name?this.layer.name:this.layer.layers;options.format=this.layer.format;options.transparent=this.layer.transparent.toUpperCase();options.visibility=this.layer.visibility;options.opacity=this.layer.opacity;options.styles=this.layer.styles;if(this.layer.style)options.styles=this.layer.style;if(this.layer.sldurl)options.sld=this.layer.sldurl;if(this.layer.cql_filter)options.cql_filter=this.layer.cql_filter;if(this.layer.sld_body)options.sld_body=this.layer.sld_body;this.layer.layers=this.layer.layername?this.layer.layername:this.layer.layers;return options},redraw:function(fenixmap){var l=this;if(l.layer.layertype){switch(l.layer.layertype){case"JOIN":if(l.layer.jointype.toLocaleUpperCase()=="SHADED"){if(fenixmap)fenixmap.addLayer(this);else if(this._fenixmap)this._fenixmap.addLayer(this)}else if(l.layer.jointype.toLocaleUpperCase()=="POINT")console.log("TODO: handle redraw point");break;case"WMS":this.createLayerWMS();this.leafletLayer.redraw();break;default:this.createLayerWMS();this.leafletLayer.redraw();break}}},removeLayer:function(fenixmap){if(fenixmap)fenixmap.removeLayer(this);else if(this._fenixmap)this._fenixmap.removeLayer(this)},addPointLayer:function(fenixmap){if(fenixmap)fenixmap.addPointLayer(this);else if(this._fenixmap)this._fenixmap.addPointLayer(this)},addLayerWMS:function(fenixmap){if(fenixmap)fenixmap.addLayerWMS(this);else if(this._fenixmap)this._fenixmap.addLayerWMS(this)},addLayer:function(fenixmap){if(fenixmap)fenixmap.addLayer(this);else if(this._fenixmap)this._fenixmap.addLayer(this)},addShadedLayer:function(fenixmap){if(fenixmap)fenixmap.addShadedLayer(this);else if(this._fenixmap)this._fenixmap.addShadedLayer(this)},createShadedLayerRequestCached:function(fenixmap){if(fenixmap){fenixmap.controller.layerAdded(this);fenixmap.createShadedLayerRequestCached(this)}else if(this._fenixmap){this._fenixmap.controller.layerAdded(this);this._fenixmap.createShadedLayerRequestCached(this)}},createShadeLayerRequestCached:function(fenixmap,loadLayer){if(this._fenixmap)fenixmap=this._fenixmap;var l=this;var r=new RequestHandler;var url="http://"+FM.CONFIG.BASEURL_MAPS+FM.CONFIG.MAP_SERVICE_SHADED;r.open("POST",url);r.setContentType("application/x-www-form-urlencoded");r.onload(function(){var response=this.responseText;if(typeof response=="string"){response=$.parseJSON(response)}l.layer.sldurl=response.sldurl;l.layer.urlWMS=response.geoserverwms;l.layer.legendHTML=response.legendHTML;l.createLayerWMSSLD();if(loadLayer){fenixmap.controller.layerAdded(l);fenixmap._loadLayer(l,false)}});r.send(FM.Util.parseLayerRequest(l.layer))}});FM.layer=function(layer,map){return new FM.Layer(layer,map)};FM.TileLayer=FM.Layer.extend({createTileLayer:function(){var tileTitle="TITLE_"+this.layer.lang.toUpperCase();var layer=this.layer.layername?FM.TILELAYER[this.layer.layername]:FM.TILELAYER[this.layer.layers];this.layer.layertitle={};this.layer.layertitle=layer[tileTitle];this.layer.layertype="TILE";var leafletLayer=new L.TileLayer(layer.URL);return leafletLayer}});FM.TileLayer.createBaseLayer=function(layername,lang){var layer={};layer.layername=layername;layer.layers=layername;layer.layertype="TILE";layer.lang=lang;var l=new FM.TileLayer(layer);l.leafletLayer=l.createTileLayer(layer.layername);return l};FM.guiController={boxIcons:'<div id="REPLACE-controller-box-icons-container" class="fm-icon-box-background fm-controller-box-icons-container"></div>',box:""+'<div class="fm-box-zindex fm-icon-box-background fm-controller-box-icons-container fm-controller-box" style="display:none" id="REPLACE-controller-box">'+'<div id="REPLACE-controller-box-content"></div>'+"</div>"+"",baselayerIcon:"<div class='fm-box-zindex'><div class='fm-icon-sprite fm-baselayers' id='REPLACE-controller-baselayerIcon'><div></div>",baselayerBox:'<div class="fm-box-zindex" id="REPLACE-controller-baselayer-box" style="display:none">'+'<div id="REPLACE-controller-baselayer-title" class="fm-controller-box-title">Baselayers</div>'+'<div id="REPLACE-controller-baselayer-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div>'+'<div class="fm-standard-hr"></div>'+'<div id="REPLACE-controller-baselayer-content" class="fm-controller-box-content"></div>'+"</div>",baselayer:'<div id="REPLACE-controller-box-item" class="fm-box-zindex fm-controller-box-item-baselayer-content">'+'<div id="REPLACE-controller-item">'+'<div class="fm-controller-box-item-baselayer-image" id="REPLACE-controller-item-baselayer-image"></div>'+'<div class="fm-controller-box-item-baselayer-text">'+"<div>"+'<label class="fm-controller-box-item-baselayer-text fm-controller-item-title" id="REPLACE-controller-item-title"><input id="REPLACE-controller-item-radio"  class="fm-checkbox-hide" type="radio" name="MAPID" value="REPLACE"><label>'+"</div>"+'<div style="clear:both"></div>'+'<div class="fm-opacity-slider-baselayers" id="REPLACE-controller-item-opacity" style="display:none"></div>'+"</div>"+"</div>"+"</div>",overlayIcon:"<div class='fm-box-zindex'><div class='fm-icon-sprite fm-overlays' id='REPLACE-controller-overlayIcon'></div></div>",overlayBox:'<div class="fm-box-zindex" id="REPLACE-controller-overlay-box" style="display:none;">'+'<div id="REPLACE-controller-overlay-title" class="fm-controller-box-title">Selected Layers</div>'+'<div id="REPLACE-controller-overlay-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div>'+'<div class="fm-standard-hr"></div>'+'<div id="REPLACE-controller-overlay-content" class="fm-controller-box-content"></div>'+"</div>",overlay:'<div id="REPLACE-controller-item-box" class="fm-box-zindex fm-controller-box-item">'+'<div id="REPLACE-controller-item" class="fm-controller-box-header">'+'<div class="fm-controller-box-header-text">'+'<div class="fm-controller-item-title" id="REPLACE-controller-item-title" ></div>'+'<div class="fm-icon-right fm-icon-layer-panel-sprite fm-icon-down" id="REPLACE-controller-item-showhide-subicons"></div>'+'<div class="fm-icon-right fm-icon-layer-panel-sprite fm-icon-panel-remove" id="REPLACE-controller-item-remove"></div>'+'<div class="fm-icon-right fm-icon-layer-panel-sprite fm-icon-panel-info" id="REPLACE-controller-item-icon" ></div>'+"</div>"+'<div style="clear:both"></div>'+'<div class="fm-controller-box-icons">'+'<div class="fm-icon-enable" id="REPLACE-controller-item-enabledisable"></div>'+'<div  class="fm-opacity-slider" style="margin-right:10px;" id="REPLACE-controller-item-opacity"></div>'+"</div>"+'<div style="clear:both"></div>'+'<div class="fm-controller-box-subicons" id="REPLACE-controller-item-subicons" style="display:none;">'+'<div class="fm-icon-layer-subicons-sprite fm-icon-getlegend" id="REPLACE-controller-item-getlegend"></div>'+'<div class="fm-icon-layer-subicons-sprite fm-icon-getfeatureinfo" id="REPLACE-controller-item-getfeatureinfo"></div>'+'<div class="fm-icon-layer-subicons-sprite fm-icon-switchJoinType" id="REPLACE-controller-item-switchjointype" style="display:none"></div>'+'<div class="fm-icon-layer-subicons-sprite fm-icon-zoomto" id="REPLACE-controller-item-zoomtolayer" style="display:none"></div>'+'<div class="fm-icon-layer-subicons-sprite fm-icon-swipe" id="REPLACE-controller-item-swipe"></div>'+'<div class="fm-icon-layer-subicons-sprite fm-icon-switchJoinType" id="REPLACE-controller-item-joinsettings" style="display:none"></div>'+"</div>"+"</div>"+"</div>"+"</div>"+"</div>",wmsLoaderIcon:"<div class='fm-box-zindex'><div class='fm-icon-sprite fm-wmsloader' id='REPLACE-controller-wmsLoaderIcon'></div></div>",wmsLoaderBox:'<div class="fm-box-zindex" id="REPLACE-controller-wmsLoader-box" style="display:none; min-height:300px;">'+'<div id="REPLACE-controller-wmsLoader-title" class="fm-controller-box-title">WMS Loader</div>'+'<div id="REPLACE-controller-wmsLoader-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div>'+'<div class="fm-standard-hr"></div>'+'<div class="clear:both"></div>'+'<div class="fm-WMSLoaderDropDown" id="REPLACE-controller-wmsLoader-dropdown"></div>'+'<div id="REPLACE-controller-wmsLoader-content" class="fm-controller-wmsLoader-content"></div>'+"</div>",wmsLoaderLayer:'<div id="REPLACE-WMSLayer-box" class="fm-WMSLayer-box">'+'<div id="REPLACE-WMSLayer-icon" class="fm-controller-box-icon fm-icon-info"></div>'+'<div id="REPLACE-WMSLayer-title" class="fm-WMSLayer-title"></div>'+"</div>",legend:'<div class="fm-box-zindex fm-icon-box-background fm-box-legend" id="REPLACE-controller-item-getlegend-holder">'+'<div class="fm-legend-title-content">'+'<div id="REPLACE-controller-item-getlegend-legend-layertitle" class="fm-legend-layertitle"></div>'+'<div id="REPLACE-controller-item-getlegend-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div>'+"</div>"+'<div class="fm-standard-hr"></div>'+'<div id="REPLACE-controller-item-getlegend-legendtitle" class="fm-legendtitle"></div>'+'<div id="REPLACE-controller-item-getlegend-legendsubtitle" class="fm-legendsubtitle"></div>'+'<div id="REPLACE-controller-item-getlegend-content" ></div>'+"</div>",popUpJoinPoint:'<div class="fm-box fm-popup-join-point-holder" id="REPLACE-popup-join-point-holder" style="display:none">'+'<div class="fm-popup-join-point-text" id="REPLACE-popup-join-point-text"></div>'+'<div class="fm-popup-join-point-value" id="REPLACE-popup-join-point-value"></div>'+"</div>"};FM.guiMap={disclaimerfao:'<div class="fm-icon-box-background fm-disclaimerfao fm-btn-icon"><div class="fm-icon-sprite fm-icon-info" id="REPLACE-disclaimerfao"></div></div>',disclaimerfao_E:'<div class="fm-disclaimerfao-text">'+"The designations employed and the presentation of material in the maps  <br>"+"do not imply the expression of any opinion whatsoever on the part of <br>"+"FAO concerning the legal or constitutional status of any country,<br>"+"territory or sea area, or concerning the delimitation of frontiers.<br>"+"South Sudan declared its independence on July 9, 2011.<br>"+"Due to data availability, the assessment presented in the map for Sudan<br>"+"and South Sudan reflects thesituation up to 2011 for the former Sudan."+"</div> ",disclaimerfao_E:"The designations employed and the presentation of material in the maps "+"do not imply the expression of any opinion whatsoever on the part of "+"FAO concerning the legal or constitutional status of any country, "+"territory or sea area, or concerning the delimitation of frontiers. "+"South Sudan declared its independence on July 9, 2011. "+"Due to data availability, the assessment presented in the map for Sudan "+"and South Sudan reflects thesituation up to 2011 for the former Sudan.",disclaimerfao_S:"",disclaimerfao_S_styled:'<div class="fm-disclaimerfao-text"></div> ',disclaimerfao_F:"",disclaimerfao_F_styled:'<div class="fm-disclaimerfao-text">'+"</div> "};var FMPopUp=function(){var o={id:null,parentID:null,content:null,style:"display:none; "+"z-index:5000; "+"position:absolute; "+"bottom:10px; right:10px; "+"padding:15px; background-color:#000000; color:#FFFFFF;",timeout:2500};function init(obj){o=$.extend(true,{},o,obj);renderPopUp()}function renderPopUp(){var id=o.id?o.id:randomID();var html='<div id="'+id+'" style="'+o.style+'">'+o.content+" </div>";$("#"+o.parentID).append(html);$("#"+id).slideDown("slow");window.setTimeout(function(){$("#"+id).slideUp("slow",function(){$("#"+id).remove()})},o.timeout)}function randomID(){var randLetter=Math.random().toString(36).substring(7);return(randLetter+Date.now()).toLocaleLowerCase()}return{init:init}}();